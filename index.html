<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">
  <title>Health OS</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } } }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">

  <!-- React 18 (CRITICAL FIX: CORE FIRST, DOM SECOND) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- FIREBASE JS SDKS (COMPATIBILITY VERSION) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      background: #020617;
      color: white;
      overscroll-behavior: none;
    }

    #loader {
      position: fixed;
      inset: 0;
      background: #020617;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.7s;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .input-box {
      background-color: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      text-align: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      width: 100%;
      height: 44px;
      outline: none;
      transition: all 0.2s;
    }
  </style>
</head>

<body class="min-h-screen">

  <div id="loader">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-slate-800 border-t-cyan-500 rounded-full animate-spin mb-6"></div>
      <div class="text-3xl font-black tracking-tighter">Health OS</div>
      <div class="text-sm text-slate-500 mt-2 tracking-widest" id="loader-status">CONNECTING</div>
    </div>
  </div>

  <div id="root" class="opacity-0 transition-opacity duration-700"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- LOCAL STORAGE HELPERS ---
    const loadItem = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) || def; } catch { return def; } };
    const saveItem = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch { } };
    const loadKey = (k) => { try { return localStorage.getItem(k) || ''; } catch { return ''; } };
    const saveKey = (k, v) => { try { localStorage.setItem(k, v); } catch { } };

    // --- 1. HARDCODED CONFIG ---
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBUiU8DmIgQH843AqqM4oiK22i4p2UJdp0",
      authDomain: "healthos-3d23f.firebaseapp.com",
      projectId: "healthos-3d23f",
      appId: "1:1071494735916:web:65d641926c7511ee5c4989",
    };

    // --- END HARDCODED CONFIG ---

    const DEFAULT_GOALS = { calories: 2350, protein: 180, carbs: 250, fat: 80 };
    const GOALS = DEFAULT_GOALS;
    let GEMINI_KEY = ''; // Cloud managed

    const DEFAULT_WORKOUTS = [
      {
        id: "push",
        name: "Push",
        color: "#ec4899",
        emoji: "üò§",
        exercises: [
          { name: "Bench Press", bodyweight: false },
          { name: "Overhead Press", bodyweight: false },
          { name: "Incline Dumbbell Press", bodyweight: false },
          { name: "Lateral Raises", bodyweight: false },
          { name: "Tricep Pushdowns", bodyweight: false },
          { name: "Skullcrushers", bodyweight: false }
        ]
      },
      {
        id: "legs",
        name: "Legs",
        color: "#3b82f6",
        emoji: "üçó",
        exercises: [
          { name: "Squat", bodyweight: false },
          { name: "Romanian Deadlift", bodyweight: false },
          { name: "Leg Press", bodyweight: false },
          { name: "Leg Extensions", bodyweight: false },
          { name: "Hamstring Curls", bodyweight: false },
          { name: "Calf Raises", bodyweight: false }
        ]
      },
      {
        id: "pull",
        name: "Pull",
        color: "#10b981",
        emoji: "ü¶ç",
        exercises: [
          { name: "Pull-ups", bodyweight: true },
          { name: "Barbell Row", bodyweight: false },
          { name: "Lat Pulldowns", bodyweight: false },
          { name: "Face Pulls", bodyweight: false },
          { name: "Bicep Curls", bodyweight: false },
          { name: "Hammer Curls", bodyweight: false }
        ]
      }
    ];

    // --- FIREBASE GLOBALS ---
    let DB = null;
    let AUTH = null;
    let USER_ID = null;

    // --- HELPER FUNCTIONS ---
    const getLocalISODate = (d = new Date()) => {
      const offset = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - offset).toISOString().split('T')[0];
    };

    // --- COMPONENT: ICONS ---
    const Icon = ({ name, size = 24, className, onClick }) => {
      const i = {
        Trash: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />, Settings: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      };
      return <svg className={`w-${size / 4} h-${size / 4} ${className}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" onClick={onClick}>{i[name]}</svg>;
    };

    // --- COMPONENT: ACTIVITY RINGS (HELPER) ---
    const Ring = ({ r, progress, color }) => {
      const circum = 2 * Math.PI * r;
      const dash = (progress / 100) * circum;
      return <circle cx="128" cy="128" r={r} stroke={color} strokeWidth="14" fill="none" strokeDasharray={circum} strokeDashoffset={circum - dash} strokeLinecap="round" transform="rotate(-90 128 128)" className="transition-all duration-1000" style={{ filter: `drop-shadow(0 0 8px ${color})` }} />;
    };

    const NutrientLegend = ({ cals, prot, carb, fat, goals }) => (
      <div className="grid grid-cols-2 gap-2 mt-6 w-full max-w-md text-center">
        {[
          { val: cals, goal: goals.calories, label: 'Cals', color: 'text-emerald-400' },
          { val: prot, goal: goals.protein, label: 'Prot', color: 'text-blue-400' },
          { val: carb, goal: goals.carbs, label: 'Carb', color: 'text-amber-400' },
          { val: fat, goal: goals.fat || 80, label: 'Fat', color: 'text-rose-400' }
        ].map((m, i) => (
          <div key={i} className="flex flex-col items-center">
            <div className={`${m.color} font-bold text-3xl whitespace-nowrap`}>{m.val || 0} <span className="text-slate-600 text-xs">/ {m.goal}</span></div>
            <div className="text-xs font-black my-0.5">{Math.round(((m.val || 0) / m.goal) * 100)}%</div>
            <div className="text-xs text-slate-500 uppercase tracking-wider font-bold">{m.label}</div>
          </div>
        ))}
      </div>
    );

    const ActivityRings = ({ cals, prot, carb, fat, goals, scale = 1 }) => {
      const pct = (v, g) => Math.min(100, (v / g) * 100);

      return (
        <div className="flex flex-col items-center mb-8" style={{ transform: `scale(${scale})` }}>
          <div className="relative w-64 h-64">
            <svg viewBox="0 0 256 256">
              {/* Background Rings */}
              <circle cx="128" cy="128" r="110" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3" />
              <circle cx="128" cy="128" r="90" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3" />
              <circle cx="128" cy="128" r="70" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3" />
              <circle cx="128" cy="128" r="50" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3" />

              {/* Progress Rings */}
              <Ring r={110} progress={pct(cals, goals.calories)} color="#10b981" />
              <Ring r={90} progress={pct(prot, goals.protein)} color="#3b82f6" />
              <Ring r={70} progress={pct(carb, goals.carbs)} color="#f59e0b" />
              <Ring r={50} progress={pct(fat, goals.fat || 80)} color="#f43f5e" />
            </svg>
          </div>

          {/* Legend */}
          <NutrientLegend cals={cals} prot={prot} carb={carb} fat={fat} goals={goals} />
        </div>
      );
    };

    // --- AUTH MODAL ---
    const AuthModal = ({ showToast }) => {
      const [mode, setMode] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async () => {
        if (!email || !password) return setError('Email and password required.');
        setIsLoading(true);
        setError('');

        try {
          if (mode === 'signup') {
            await AUTH.createUserWithEmailAndPassword(email, password);
          } else {
            await AUTH.signInWithEmailAndPassword(email, password);
          }
          showToast('Logged in successfully!', 'success');

        } catch (e) {
          let msg = "Authentication failed. Check credentials and ensure Email/Password is enabled in Firebase.";
          if (e.code) {
            msg = e.message.replace('Firebase:', '').trim();
          }
          setError(msg);
        } finally {
          setIsLoading(false);
        }
      };

      const handleGoogleSignIn = async () => {
        setIsLoading(true);
        setError('');
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await AUTH.signInWithPopup(provider);
        } catch (e) {
          if (e.code !== 'auth/popup-closed-by-user') {
            setError('Google sign-in failed. Ensure Google provider is enabled in Firebase.');
          }
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md">
          <div className="bg-slate-900/90 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl">
            <h3 className="text-3xl font-black mb-6 text-center">{mode === 'login' ? 'Log In' : 'Create Account'}</h3>

            {error && <div className="bg-red-600/20 text-red-400 p-3 rounded-lg mb-4 text-sm">{error}</div>}

            <button onClick={handleGoogleSignIn} disabled={isLoading}
              className="w-full py-4 rounded-xl font-bold mb-3 bg-slate-800 text-white hover:bg-slate-700 transition-colors disabled:opacity-50">
              {isLoading ? '...' : 'Sign in with Google'}
            </button>

            <div className="text-center text-xs text-slate-600 mb-3 uppercase tracking-widest">or</div>

            <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)}
              className="w-full bg-slate-800 p-4 rounded-xl mb-3 border border-slate-700 outline-none" />
            <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)}
              className="w-full bg-slate-800 p-4 rounded-xl mb-6 border border-slate-700 outline-none" />

            <button onClick={handleSubmit} disabled={isLoading}
              className={`w-full py-4 rounded-xl font-bold text-lg ${mode === 'login' ? 'bg-cyan-600 hover:bg-cyan-500' : 'bg-emerald-600 hover:bg-emerald-500'} disabled:opacity-50 transition-colors`}>
              {isLoading ? 'Processing...' : mode === 'login' ? 'Log In' : 'Create Account'}
            </button>

            <button onClick={() => setMode(mode === 'login' ? 'signup' : 'login')}
              className="w-full mt-4 text-slate-400 text-sm hover:text-white transition-colors">
              {mode === 'login' ? "Don't have an account? Sign Up" : "Already have an account? Log In"}
            </button>
          </div>
        </div>
      );
    };

    // --- SETTINGS MODAL ---
    const SettingsModal = ({ isVisible, onClose, onSave, currentKey, goals, setGoals, calendarView, setCalendarView }) => {
      const [localGoals, setLocalGoals] = useState(goals);

      // Update local state when prop changes (after cloud load)
      useEffect(() => {
        setLocalGoals(goals);
      }, [goals]);

      if (!isVisible) return null;

      const handleSaveGoals = async () => {
        try {
          await DB.collection('users').doc(AUTH.currentUser.uid).collection('settings').doc('profile').set({ goals: localGoals }, { merge: true });
          setGoals(localGoals); // Update state in App
          onClose();
          showToast('Personal goals saved!', 'success');
        } catch {
          showToast('Failed to save goals to cloud.', 'error');
        }
      };

      return (
        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
          <div className="bg-slate-900/90 border border-slate-700 p-6 rounded-xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh]" onClick={e => e.stopPropagation()}>
            <h3 className="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Application Settings</h3>

            {/* Goals for all users (Always Visible) */}
            <h3 className="text-xl font-bold mb-4 border-b border-slate-700 pt-4 pb-2 text-cyan-400">Personal Goals</h3>
            <div className="space-y-3">
              {Object.entries(localGoals).map(([k, v]) => (
                <div key={k}>
                  <label className="text-sm text-slate-400 uppercase">{k === 'calories' ? 'Calories' : `${k} (g)`}</label>
                  <input type="number" value={v} onChange={e => setLocalGoals(prev => ({ ...prev, [k]: Number(e.target.value) }))} className="w-full bg-slate-950 p-3 rounded-xl border border-slate-700 mt-2" />
                </div>
              ))}
              <button onClick={handleSaveGoals} className="w-full py-3 bg-emerald-600 rounded-xl font-bold text-lg hover:bg-emerald-500 transition-colors mt-4">Save My Goals</button>
            </div>

            <div className="mt-6 bg-slate-800 p-4 rounded-lg">
              <p className="text-sm text-slate-400 font-bold">Calendar View:</p>
              <div className="flex bg-slate-950 rounded-lg p-1 mt-2">
                <button onClick={() => setCalendarView('week')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${calendarView === 'week' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>Weekly</button>
                <button onClick={() => setCalendarView('month')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${calendarView === 'month' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>Monthly</button>
              </div>
            </div>

            <div className="mt-6 bg-slate-800 p-4 rounded-lg">
              <p className="text-sm text-slate-400 font-bold">AI Status:</p>
              <p className={`text-lg font-bold mt-1 ${currentKey ? 'text-emerald-400' : 'text-red-400'}`}>
                {currentKey ? 'AI Key Loaded from Cloud.' : 'AI Key Missing.'}
              </p>
              <p className="text-xs text-slate-500 mt-2">The AI key is managed directly in the Firebase Console: app_config/shared_keys.</p>
            </div>


            <div className="text-center mt-4">
              <button onClick={onClose} className="w-full py-2 bg-slate-700 rounded-xl font-bold hover:bg-slate-600 text-sm">Close Settings</button>
            </div>
          </div>
        </div>
      );
    };

    // --- EDIT FOOD MODAL ---
    const EditFoodModal = ({ item, onClose, onSave }) => {
      const [edited, setEdited] = useState(item);
      const [baseValues, setBaseValues] = useState(null);

      useEffect(() => {
        setEdited(item);
        if (item) {
          const qty = item.quantity || 1;
          setBaseValues({
            cals: (item.cals || 0) / qty,
            prot: (item.prot || 0) / qty,
            carb: (item.carb || 0) / qty,
            fat: (item.fat || 0) / qty
          });
        }
      }, [item]);

      if (!item || !edited) return null;

      const handleQuantityChange = (val) => {
        const q = parseFloat(val);
        const newEdited = { ...edited, quantity: val }; // Allow string for typing

        if (!isNaN(q) && baseValues) {
          newEdited.cals = Math.round(baseValues.cals * q);
          newEdited.prot = Math.round(baseValues.prot * q);
          newEdited.carb = Math.round(baseValues.carb * q);
          newEdited.fat = Math.round(baseValues.fat * q);
        }
        setEdited(newEdited);
      };

      const handleSave = () => {
        onSave(edited);
      };

      return (
        <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
          <div className="bg-slate-900/90 border border-slate-700 p-6 rounded-xl w-full max-w-md shadow-2xl" onClick={e => e.stopPropagation()}>
            <h3 className="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Edit Entry</h3>

            <div className="space-y-4">
              <div>
                <label className="text-xs text-slate-500 uppercase font-bold">Name</label>
                <input className="w-full bg-slate-950/70 border border-slate-700 rounded-lg p-3 text-lg font-bold mt-1"
                  value={edited.name} onChange={e => setEdited({ ...edited, name: e.target.value })} />
              </div>

              <div>
                <label className="text-xs text-slate-500 uppercase font-bold">Quantity</label>
                <input type="number" className="w-full bg-slate-950/70 border border-slate-700 rounded-lg p-3 text-lg font-bold mt-1"
                  value={edited.quantity || 1} onChange={e => handleQuantityChange(e.target.value)} />
              </div>

              <div className="grid grid-cols-4 gap-3">
                {['cals', 'prot', 'carb', 'fat'].map(k => (
                  <div key={k}>
                    <label className="text-[10px] text-slate-500 uppercase font-bold block text-center mb-1">{k}</label>
                    <input type="number" className="w-full bg-slate-950/70 border border-slate-700 rounded-lg p-2 text-center font-bold"
                      value={edited[k]} onChange={e => setEdited({ ...edited, [k]: Number(e.target.value) })} />
                  </div>
                ))}
              </div>

              <div className="flex gap-3 mt-6">
                <button onClick={onClose} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold hover:bg-slate-700">Cancel</button>
                <button onClick={handleSave} className="flex-1 py-3 bg-emerald-600 rounded-xl font-bold hover:bg-emerald-500">Save Changes</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // --- CALENDAR COMPONENT ---
    const Calendar = ({ datesWithData, selectedDate, onSelect, viewMode = 'week' }) => {
      const [viewDate, setViewDate] = useState(new Date());

      // Reset viewDate to selectedDate when selectedDate changes to ensure visibility
      useEffect(() => {
        setViewDate(new Date(selectedDate));
      }, [selectedDate]);

      const getDays = () => {
        if (viewMode === 'month') {
          const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
          const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
          const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
          const empties = Array.from({ length: firstDay }, (_, i) => i);
          return { days, empties, label: viewDate.toLocaleDateString('en', { month: 'long', year: 'numeric' }) };
        } else {
          // Week View
          const current = new Date(viewDate);
          const day = current.getDay();
          const diff = current.getDate() - day; // Adjust when day is Sunday
          const startOfWeek = new Date(current.setDate(diff));
          const days = [];
          for (let i = 0; i < 7; i++) {
            const d = new Date(startOfWeek);
            d.setDate(startOfWeek.getDate() + i);
            days.push(d);
          }
          // Label: "Nov 1 - Nov 7"
          const endOfWeek = days[6];
          const label = `${days[0].toLocaleDateString('en', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en', { month: 'short', day: 'numeric' })}`;
          return { days, empties: [], label, isWeek: true };
        }
      };

      const { days, empties, label, isWeek } = getDays();

      const changeView = (delta) => {
        if (viewMode === 'month') {
          setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + delta, 1));
        } else {
          const newDate = new Date(viewDate);
          newDate.setDate(viewDate.getDate() + (delta * 7));
          setViewDate(newDate);
        }
      };

      const isToday = (d) => {
        const today = new Date();
        const target = isWeek ? d : new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
        return target.getDate() === today.getDate() && target.getMonth() === today.getMonth() && target.getFullYear() === today.getFullYear();
      };

      const isSelected = (d) => {
        const sel = new Date(selectedDate);
        const target = isWeek ? d : new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
        return target.getDate() === sel.getDate() && target.getMonth() === sel.getMonth() && target.getFullYear() === sel.getFullYear();
      };

      const hasData = (d) => {
        const target = isWeek ? d : new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
        const dateStr = getLocalISODate(new Date(target.getFullYear(), target.getMonth(), target.getDate(), 12));
        return datesWithData.includes(dateStr);
      };

      return (
        <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-4 border border-slate-700">
          <div className="flex justify-between items-center mb-2">
            <button onClick={() => changeView(-1)} className="p-1 hover:bg-slate-800 rounded-full">‚Üê</button>
            <div className="font-bold text-base text-slate-300">
              {label}
            </div>
            <button onClick={() => changeView(1)} className="p-1 hover:bg-slate-800 rounded-full">‚Üí</button>
          </div>
          <div className="grid grid-cols-7 gap-1 text-center text-xs">
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => <div key={d} className="text-slate-500 py-1">{d}</div>)}
            {empties.map(i => <div key={`e-${i}`} />)}
            {days.map((d, i) => {
              const dayNum = isWeek ? d.getDate() : d;
              const dateObj = isWeek ? d : new Date(viewDate.getFullYear(), viewDate.getMonth(), d);

              return (
                <button key={i} onClick={() => onSelect(getLocalISODate(new Date(dateObj.getFullYear(), dateObj.getMonth(), dayNum, 12)))}
                  className={`relative py-2 rounded-lg font-bold transition-all ${isSelected(isWeek ? d : dayNum) ? 'bg-cyan-600 text-white' : 'hover:bg-slate-800 text-slate-300'} ${isToday(isWeek ? d : dayNum) ? 'border border-cyan-500' : ''}`}>
                  {dayNum}
                  {hasData(isWeek ? d : dayNum) && <div className="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-1 h-1 bg-emerald-400 rounded-full" />}
                </button>
              );
            })}
          </div>
        </div>
      );
    };

    // --- TAB COMPONENTS ---

    const SummaryTab = ({ data, allFood, allGym, allCardio, selectedDate, onSelectDate, calendarView, onNavigate, onSubNavigate, onSetEditingLog }) => {
      const datesWithData = useMemo(() => {
        return [...new Set([...allFood.map(f => f.date), ...allGym.map(g => g.date), ...allCardio.map(c => c.date)])];
      }, [allFood, allGym, allCardio]);

      const dayData = useMemo(() => {
        const food = allFood.filter(f => f.date === selectedDate);
        const gym = allGym.filter(g => g.date === selectedDate);
        const cardio = allCardio.filter(c => c.date === selectedDate);

        const totals = food.reduce((acc, item) => ({
          cals: acc.cals + (item.cals || 0),
          prot: acc.prot + (item.prot || 0),
          carb: acc.carb + (item.carb || 0),
          fat: acc.fat + (item.fat || 0)
        }), { cals: 0, prot: 0, carb: 0, fat: 0 });

        return { food, gym, cardio, totals };
      }, [selectedDate, allFood, allGym, allCardio]);

      return (
        <div className="space-y-6">
          {/* Top: Calendar */}
          <Calendar datesWithData={datesWithData} selectedDate={selectedDate} onSelect={onSelectDate} viewMode={calendarView} />

          <div className="grid grid-cols-2 gap-4">
            {/* Left: Rings (Food) */}
            <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-4 border border-slate-700 flex flex-col items-center">
              <h3 className="text-lg font-bold mb-2 text-slate-300 self-start">Food</h3>
              <ActivityRings scale={0.65} cals={dayData.totals.cals} prot={dayData.totals.prot} carb={dayData.totals.carb} fat={dayData.totals.fat} goals={data.goals || GOALS} />
            </div>

            {/* Right: Activity Summary */}
            <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-4 border border-slate-700 flex flex-col">
              <h3 className="text-lg font-bold mb-2 text-slate-300">Activity</h3>
              <div className="flex-1 space-y-3 overflow-y-auto max-h-48 pr-1 custom-scrollbar">
                {dayData.gym.length === 0 && dayData.cardio.length === 0 && <div className="text-slate-500 text-center py-8 text-sm">No activity.</div>}

                {dayData.gym.map(g => (
                  <div key={g.id} onClick={() => { onNavigate('activity'); onSubNavigate('gym'); onSetEditingLog(g); }} className="bg-slate-900/50 p-3 rounded-xl border-l-4 border-cyan-500 cursor-pointer hover:bg-slate-800 transition-colors">
                    <div className="font-bold text-white">{g.workoutName}</div>
                    <div className="text-xs text-slate-400">{g.exercises.length} Exercises</div>
                  </div>
                ))}
                {dayData.cardio.map(c => {
                  const color = c.type === 'run' ? 'border-emerald-500' : c.type === 'cycle' ? 'border-amber-500' : 'border-blue-500';
                  const icon = c.type === 'run' ? 'üèÉ' : c.type === 'cycle' ? 'üö¥' : 'üèä';
                  return (
                    <div key={c.id} onClick={() => { onNavigate('activity'); onSubNavigate('cardio'); onSetEditingLog(c); }} className={`bg-slate-900/50 p-3 rounded-xl border-l-4 ${color} cursor-pointer hover:bg-slate-800 transition-colors`}>
                      <div className="flex justify-between items-center">
                        <div className="font-bold text-white capitalize flex items-center gap-1">
                          {icon} {c.type === 'class' ? c.className : c.type}
                        </div>
                        <div className="text-xs font-bold text-white">{c.calories} cal</div>
                      </div>
                    </div>
                  );
                })}</div>
            </div>
          </div>
        </div>
      );
    };

    const GeminiFoodEntry = ({ isReady, userId, showToast, isConfigLoaded, selectedDate }) => {
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const [baseResult, setBaseResult] = useState(null);
      const [quantity, setQuantity] = useState(1);
      const [entryTime, setEntryTime] = useState(new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }));
      const [category, setCategory] = useState('Snack');

      const getCategory = (time) => {
        const hour = parseInt(time.split(':')[0]);
        if (hour >= 5 && hour < 11) return 'Breakfast';
        if (hour >= 11 && hour < 15) return 'Lunch';
        if (hour >= 15 && hour < 22) return 'Dinner';
        return 'Snack';
      };

      useEffect(() => {
        setCategory(getCategory(entryTime));
      }, [entryTime]);

      // Check key readiness
      const isAiReady = isConfigLoaded && GEMINI_KEY;

      const analyze = async () => {
        if (!input.trim()) return;
        if (!GEMINI_KEY) return showToast('AI Key Missing.', 'error');
        setLoading(true);
        try {
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `Return ONLY valid JSON (no markdown): {"name":"string","cals":number,"prot":number,"carb":number,"fat":number}. Food: ${input}` }] }]
            })
          });

          const data = await res.json();
          const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

          if (!responseText) throw new Error('Empty response from AI.');

          const jsonString = responseText.trim().replace(/```json|```/g, '');
          const json = JSON.parse(jsonString);
          setResult(json);
          setBaseResult(json);
          setQuantity(1);

        } catch (e) {
          showToast('AI failed. Check key/input.', 'error');
          console.error("Gemini Failure:", e);
        }
        setLoading(false);
      };

      const handleQuantityChange = (val) => {
        const q = parseFloat(val);
        setQuantity(val); // Allow string for typing
        if (!isNaN(q) && baseResult) {
          setResult({
            ...result,
            cals: Math.round(baseResult.cals * q),
            prot: Math.round(baseResult.prot * q),
            carb: Math.round(baseResult.carb * q),
            fat: Math.round(baseResult.fat * q)
          });
        }
      };

      const add = async () => {
        if (!result || !isReady || !userId) return showToast('Database not ready.', 'error');
        const baseRef = DB.collection('users').doc(userId).collection('food_logs');

        try {
          await baseRef.add({
            date: selectedDate,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            name: result.name,
            cals: Number(result.cals) || 0,
            prot: Number(result.prot) || 0,
            carb: Number(result.carb) || 0,
            fat: Number(result.fat) || 0,
            quantity: Number(quantity) || 1,
            time: entryTime,
            category: category
          });
          setInput('');
          setResult(null);
          setBaseResult(null);
          setQuantity(1);
          showToast('Food logged!', 'success');
        } catch (e) {
          showToast('Logging failed. Database error.', 'error');
          console.error("Firestore Error:", e);
        }
      };

      return (
        <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-6 mb-8 border border-slate-700">
          <div className="flex gap-3 mb-4">
            <div className="flex-1 flex flex-col gap-2">
              <input className="w-full bg-slate-950/70 border border-slate-700 rounded-xl px-5 py-4 text-lg placeholder-slate-500 focus:border-emerald-500 transition"
                placeholder={isConfigLoaded ? "What did you eat?" : "Loading config..."}
                value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && analyze()}
                disabled={!isConfigLoaded} />
              <div className="flex gap-2">
                <input type="time" className="bg-slate-950/70 border border-slate-700 rounded-xl px-4 py-2 text-slate-300 outline-none focus:border-emerald-500"
                  value={entryTime} onChange={e => setEntryTime(e.target.value)} />
                <select className="flex-1 bg-slate-950/70 border border-slate-700 rounded-xl px-4 py-2 text-slate-300 outline-none focus:border-emerald-500 appearance-none"
                  value={category} onChange={e => setCategory(e.target.value)}>
                  {['Breakfast', 'Lunch', 'Dinner', 'Snack'].map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
            </div>
            <button onClick={analyze} disabled={loading || !isAiReady} className="bg-emerald-600 px-8 rounded-xl font-bold disabled:opacity-50 hover:bg-emerald-500 transition-colors h-auto">
              {loading ? '...' : (!isAiReady ? 'Wait...' : 'AI')}
            </button>
          </div>
          {result && (
            <div className="space-y-4 animate-in fade-in">
              <div className="flex gap-4">
                <input className="flex-[2] bg-transparent text-xl font-bold outline-none border-b border-slate-600" value={result.name} onChange={e => setResult({ ...result, name: e.target.value })} />
                <div className="flex-1 flex items-center gap-2 border-b border-slate-600">
                  <span className="text-slate-500 text-sm font-bold">Qty:</span>
                  <input type="number" className="w-full bg-transparent text-xl font-bold outline-none text-center"
                    value={quantity} onChange={e => handleQuantityChange(e.target.value)} />
                </div>
              </div>
              <div className="grid grid-cols-4 gap-4">
                {['cals', 'prot', 'carb', 'fat'].map(k => (
                  <div key={k} className="relative">
                    <input type="number" className="w-full bg-slate-950/70 rounded-lg p-3 text-center text-xl font-bold"
                      value={result[k]} onChange={e => setResult({ ...result, [k]: e.target.value })} />
                    <div className="text-[10px] text-slate-500 text-center uppercase mt-1 font-bold">{k}</div>
                  </div>
                ))}
              </div>
              <button onClick={add} className="w-full bg-emerald-600 py-4 rounded-xl font-bold text-lg">Add to Today</button>
            </div>
          )}
        </div>
      );
    };

    const FoodTab = ({ data, isReady, userId, showToast, isConfigLoaded, selectedDate, onSelectDate }) => {
      const [editingItem, setEditingItem] = useState(null);

      const deleteFoodItem = async (docId) => {
        if (!isReady || !userId) return showToast('Database not ready.', 'error');
        try {
          await DB.collection('users').doc(userId).collection('food_logs').doc(docId).delete();
          showToast('Item deleted!', 'success');
        } catch (e) {
          showToast('Deletion failed. Check Security Rules.', 'error');
        }
      };

      const updateFoodItem = async (updatedItem) => {
        if (!isReady || !userId) return showToast('Database not ready.', 'error');
        try {
          await DB.collection('users').doc(userId).collection('food_logs').doc(updatedItem.id).update({
            name: updatedItem.name,
            quantity: Number(updatedItem.quantity) || 1,
            cals: Number(updatedItem.cals) || 0,
            prot: Number(updatedItem.prot) || 0,
            carb: Number(updatedItem.carb) || 0,
            fat: Number(updatedItem.fat) || 0,
          });
          setEditingItem(null);
          showToast('Item updated!', 'success');
        } catch (e) {
          showToast('Update failed.', 'error');
          console.error(e);
        }
      };

      const adjustQuantity = async (item, delta) => {
        if (!isReady || !userId) return showToast('Database not ready.', 'error');

        const currentQty = item.quantity || 1;
        const newQty = Math.max(0.5, currentQty + delta); // Minimum 0.5

        if (newQty === currentQty) return;

        // Calculate base values (per unit)
        const baseCals = (item.cals || 0) / currentQty;
        const baseProt = (item.prot || 0) / currentQty;
        const baseCarb = (item.carb || 0) / currentQty;
        const baseFat = (item.fat || 0) / currentQty;

        const updatedItem = {
          ...item,
          quantity: newQty,
          cals: Math.round(baseCals * newQty),
          prot: Math.round(baseProt * newQty),
          carb: Math.round(baseCarb * newQty),
          fat: Math.round(baseFat * newQty)
        };

        await updateFoodItem(updatedItem);
      };

      const isToday = selectedDate === getLocalISODate();
      const dateDisplay = isToday ? 'Today' : new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

      return (
        <>
          <EditFoodModal key={editingItem ? editingItem.id : 'modal'} item={editingItem} onClose={() => setEditingItem(null)} onSave={updateFoodItem} />

          <div className="mb-6 flex items-center justify-between relative">
            <h2 className="text-2xl font-bold text-white flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors relative">
              {dateDisplay}
              <svg className="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
              <input
                type="date"
                value={selectedDate}
                onChange={(e) => onSelectDate(e.target.value)}
                className="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
              />
            </h2>
          </div>
          <div className="mb-8">
            <NutrientLegend cals={data.totals.cals} prot={data.totals.prot} carb={data.totals.carb} fat={data.totals.fat} goals={data.goals || GOALS} />
          </div>
          <GeminiFoodEntry isReady={isReady} userId={userId} showToast={showToast} isConfigLoaded={isConfigLoaded} selectedDate={selectedDate} />
          <div className="space-y-4">
            {!isReady && <div className="text-center text-slate-500 py-6">Waiting for Database connection...</div>}
            {['Breakfast', 'Lunch', 'Dinner', 'Snack'].map(category => {
              const items = data.food.filter(f => (f.category || 'Snack') === category);
              if (items.length === 0) return null;

              return (
                <div key={category} className="space-y-3">
                  <h3 className="text-xl font-bold text-slate-300 pl-1">{category}</h3>
                  {items.map(item => (
                    <div key={item.id} onClick={() => setEditingItem(item)} className="bg-slate-900/80 backdrop-blur-xl rounded-xl p-5 flex justify-between items-center border border-slate-700 cursor-pointer hover:bg-slate-800 transition-colors">
                      <div>
                        <div className="font-bold flex items-center gap-2">
                          {item.name}
                        </div>
                        <div className="text-sm text-slate-500">{item.prot}g P ‚Ä¢ {item.carb}g C ‚Ä¢ {item.fat}g F</div>
                      </div>
                      <div className="text-right flex items-center gap-4">
                        <div className="flex items-center gap-2 bg-slate-950 rounded-lg p-1 border border-slate-800" onClick={e => e.stopPropagation()}>
                          <button onClick={() => adjustQuantity(item, -0.5)} className="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 rounded">-</button>
                          <span className="text-xs font-bold text-slate-300 w-4 text-center">{item.quantity || 1}</span>
                          <button onClick={() => adjustQuantity(item, 0.5)} className="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 rounded">+</button>
                        </div>
                        <div className="text-2xl font-black text-emerald-400 w-16 text-right">{item.cals}</div>
                        <button onClick={(e) => { e.stopPropagation(); deleteFoodItem(item.id); }} className="text-red-500 text-lg hover:text-red-400 transition-colors">√ó</button>
                      </div>
                    </div>
                  ))}
                </div>
              );
            })}
          </div>
        </>
      );
    };

    const GymTab = ({ workouts, setWorkouts, isReady, userId, showToast, stats, setStats, selectedDate, onSelectDate, gymLogs, initialData, onSave, exerciseSettings, setExerciseSettings }) => {
      const [selected, setSelected] = useState(null);
      const [logData, setLogData] = useState({});
      const [isAdding, setIsAdding] = useState(false);
      const [newExercise, setNewExercise] = useState('');
      const [newExerciseType, setNewExerciseType] = useState('weighted'); // 'weighted' or 'bodyweight'
      const [skippedExercises, setSkippedExercises] = useState([]);
      const [draggedItem, setDraggedItem] = useState(null);

      // --- 1. INITIALIZATION & HISTORY LOADING ---
      useEffect(() => {
        if (selected && userId) {
          loadLastSession(selected.id);
        }
      }, [selected]);

      const loadLastSession = async (workoutId) => {
        if (!isReady) return;

        try {
          const snapshot = await DB.collection('users').doc(userId).collection('gym_logs')
            .where('workoutId', '==', workoutId)
            .orderBy('timestamp', 'desc')
            .limit(1)
            .get();

          if (!snapshot.empty) {
            const lastLog = snapshot.docs[0].data();
            // Filter out skipped exercises from the last session
            const exercisesToLoad = Object.keys(lastLog.exercises || {}).filter(ex => {
              // Check if it was skipped in the last session (if we tracked that)
              // For now, just load all that have data
              return true;
            });

            // Reconstruct logData structure
            const newLogData = {};
            exercisesToLoad.forEach(ex => {
              newLogData[ex] = lastLog.exercises[ex];
            });
            setLogData(newLogData);
          } else {
            throw new Error("No history");
          }
        } catch (e) {
          console.log("History load error (or no history):", e);
          if (e.code === 'failed-precondition') {
            console.warn("Missing Index. Please create it:", e.message);
            // Optional: showToast("Dev: Missing Index. Check Console.", "error");
          }

          // Fallback to default list
          const defaultExercises = selected.exercises || [];
          const newLogData = {};
          defaultExercises.forEach(ex => {
            const name = typeof ex === 'string' ? ex : ex.name;
            newLogData[name] = {
              [Date.now() + Math.random()]: { w: '', r: '' },
              [Date.now() + Math.random()]: { w: '', r: '' },
              [Date.now() + Math.random()]: { w: '', r: '' }
            };
          });
          setLogData(newLogData);
        }
      };

      // --- 2. DRAG AND DROP HANDLERS ---
      const handleDragStart = (e, exercise) => {
        setDraggedItem(exercise);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = (e, exercise) => {
        e.preventDefault();
        if (draggedItem === exercise) return;

        // Reorder logData keys
        const keys = Object.keys(logData);
        const fromIndex = keys.indexOf(draggedItem);
        const toIndex = keys.indexOf(exercise);

        if (fromIndex !== -1 && toIndex !== -1) {
          const newKeys = [...keys];
          newKeys.splice(fromIndex, 1);
          newKeys.splice(toIndex, 0, draggedItem);

          const newLogData = {};
          newKeys.forEach(k => newLogData[k] = logData[k]);
          setLogData(newLogData);
        }
      };

      const handleDragEnd = () => {
        setDraggedItem(null);
      };

      // --- 3. EXERCISE MANAGEMENT ---
      const handleAddExercise = async () => {
        if (!newExercise) return;

        // Add to current session
        setLogData(prev => ({
          ...prev,
          [newExercise]: {
            [Date.now()]: { w: '', r: '' },
            [Date.now() + 1]: { w: '', r: '' },
            [Date.now() + 2]: { w: '', r: '' }
          }
        }));

        // Save metadata if new
        if (!exerciseSettings?.[newExercise]) {
          const newSettings = { ...exerciseSettings, [newExercise]: { type: newExerciseType } };
          setExerciseSettings(newSettings);
          try {
            await DB.collection('users').doc(userId).collection('settings').doc('exercises').set(newSettings, { merge: true });
          } catch (e) { console.error("Failed to save exercise settings", e); }
        }

        setNewExercise('');
        setIsAdding(false);
      };

      const finishWorkout = async () => {
        if (!isReady || !userId) return showToast('Database not ready.', 'error');

        const exercises = Object.entries(logData).map(([name, setsObj]) => {
          const sets = Object.values(setsObj)
            .filter(s => s.w || s.r) // Filter empty sets
            .map(s => ({ weight: s.w, reps: s.r }));
          return { exercise: name, sets };
        }).filter(e => e.sets.length > 0); // Filter exercises with no sets

        if (exercises.length === 0) return showToast('Log at least one set.', 'error');

        const data = {
          date: selectedDate,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          workoutId: selected.id,
          workoutName: selected.name,
          exercises
        };

        try {
          await DB.collection('users').doc(userId).collection('gym_logs').add(data);

          // Update stats (PRs)
          const newStats = { ...stats };
          exercises.forEach(ex => {
            const maxWeight = Math.max(...ex.sets.map(s => Number(s.weight) || 0));
            const bestSet = ex.sets.find(s => Number(s.weight) === maxWeight);

            if (!stats[ex.exercise] || maxWeight > stats[ex.exercise].w) {
              newStats[ex.exercise] = { w: maxWeight, r: bestSet.reps, date: selectedDate };
            }
          });
          setStats(newStats);
          await DB.collection('users').doc(userId).collection('stats').doc('exercises').set(newStats, { merge: true });

          showToast('Workout logged!', 'success');
          if (onSave) onSave(); // Go back
        } catch (e) {
          showToast('Logging failed.', 'error');
          console.error(e);
        }
      };

      const deleteLog = async () => {
        if (!initialData || !confirm('Delete this workout?')) return;
        try {
          await DB.collection('users').doc(userId).collection('gym_logs').doc(initialData.id).delete();
          showToast('Workout deleted.', 'success');
          if (onSave) onSave();
        } catch (e) {
          showToast('Delete failed.', 'error');
        }
      };

      // --- RENDER: DETAILS VIEW (READ ONLY) ---
      if (initialData) {
        return (
          <div className="space-y-6 pb-24">
            <div className="flex items-center justify-between relative">
              <h2 className="text-2xl font-bold text-white">{new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</h2>
              <button onClick={deleteLog} className="text-red-500 bg-red-500/10 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500 hover:text-white transition-colors">
                Delete
              </button>
            </div>
            <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
              <h2 className="text-3xl font-black text-white mb-6">{initialData.workoutName}</h2>
              <div className="space-y-6">
                {initialData.exercises.map((ex, idx) => (
                  <div key={idx} className="border-b border-slate-800 pb-4 last:border-0">
                    <h3 className="font-bold text-xl text-cyan-400 mb-2">{ex.exercise}</h3>
                    <div className="flex flex-wrap gap-2">
                      {ex.sets.map((set, sIdx) => (
                        <div key={sIdx} className="bg-slate-950 px-3 py-1 rounded-lg border border-slate-800 text-sm">
                          <span className="font-bold text-white">{set.weight}kg</span> <span className="text-slate-500">x</span> <span className="font-bold text-white">{set.reps}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <button onClick={onSave} className="w-full py-4 bg-slate-800 rounded-2xl font-bold text-slate-400">Close</button>
          </div>
        );
      }

      // --- RENDER: WORKOUT SELECTION ---
      if (!selected) {
        return (
          <div className="space-y-6 pb-24 animate-in fade-in">
            <div className="flex items-center justify-between relative">
              <h2 className="text-2xl font-bold text-white flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors relative">
                {selectedDate === getLocalISODate() ? 'Today' : new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                <svg className="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                <input type="date" value={selectedDate} onChange={(e) => onSelectDate(e.target.value)} className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" />
              </h2>
            </div>
            <div className="grid grid-cols-1 gap-4">
              {workouts.map(w => (
                <button key={w.id} onClick={() => setSelected(w)} className="bg-slate-900/80 border border-slate-700 p-8 rounded-3xl flex items-center justify-between hover:bg-slate-800 transition-all hover:scale-[1.02] group" style={{ borderColor: w.color }}>
                  <span className="text-3xl font-black text-white">{w.name}</span>
                  <span className="text-4xl group-hover:scale-110 transition-transform">{w.emoji || 'üí™'}</span>
                </button>
              ))}
            </div>
          </div>
        );
      }

      // --- RENDER: ACTIVE SESSION ---
      const activeExercises = Object.keys(logData).filter(ex => !skippedExercises.includes(ex));

      return (
        <div className="space-y-6 pb-24 animate-in slide-in-from-right">
          <div className="flex items-center justify-between">
            <button onClick={() => setSelected(null)} className="text-slate-400 font-bold hover:text-white">‚Üê Change Workout</button>
            <h2 className="text-2xl font-black text-white" style={{ color: selected.color }}>{selected.name}</h2>
          </div>

          <div className="space-y-4">
            {activeExercises.map((ex, idx) => {
              // Check settings OR default workout definition for bodyweight status
              const defaultEx = selected.exercises.find(e => (typeof e === 'string' ? e : e.name) === ex);
              const isBodyweight = exerciseSettings?.[ex]?.type === 'bodyweight' || defaultEx?.bodyweight;

              return (
                <div
                  key={ex}
                  draggable
                  onDragStart={(e) => handleDragStart(e, ex)}
                  onDragOver={(e) => handleDragOver(e, ex)}
                  onDragEnd={handleDragEnd}
                  className={`bg-slate-900/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700 transition-all ${draggedItem === ex ? 'opacity-50 scale-95' : ''}`}
                >
                  <div className="flex justify-between items-center mb-4 cursor-move">
                    <div>
                      <h3 className="font-bold text-xl flex items-center gap-2">
                        {ex}
                        {isBodyweight && <span className="bg-slate-700 text-[10px] px-2 py-0.5 rounded text-slate-300">BW</span>}
                      </h3>
                      {stats[ex] && <div className="text-xs text-emerald-400 font-bold mt-1">Last: {stats[ex].w}kg x {stats[ex].r}</div>}
                    </div>
                    <div className="flex gap-3">
                      <button onClick={() => setSkippedExercises(prev => [...prev, ex])} className="text-slate-500 text-sm font-bold hover:text-white">SKIP</button>
                      <button onClick={() => setLogData(prev => ({ ...prev, [ex]: { ...prev[ex], [Date.now()]: { w: '', r: '' } } }))} className="text-cyan-400 text-sm font-bold">+ ADD SET</button>
                    </div>
                  </div>

                  <div className="grid grid-cols-[auto_1fr_1fr_auto] gap-3 items-center mb-2 text-xs text-slate-500 font-bold uppercase text-center">
                    <div className="w-6">#</div>
                    <div>{isBodyweight ? '+Weight' : 'Weight'}</div>
                    <div>Reps</div>
                    <div className="w-8"></div>
                  </div>

                  <div className="space-y-2">
                    {Object.entries(logData[ex] || {}).sort(([a], [b]) => Number(a) - Number(b)).map(([setId, set], i) => (
                      <div key={setId} className="grid grid-cols-[auto_1fr_1fr_auto] gap-3 items-center">
                        <div className="w-6 text-center text-slate-500 font-bold">{i + 1}</div>
                        {!isBodyweight ? (
                          <input key="weight" type="number" placeholder="kg" value={set.w} onChange={e => setLogData(prev => ({ ...prev, [ex]: { ...prev[ex], [setId]: { ...set, w: e.target.value } } }))}
                            className="bg-slate-950 border border-slate-800 rounded-lg p-3 text-center font-bold text-white focus:border-cyan-500 outline-none transition-colors" />
                        ) : (
                          <div className="text-center text-slate-600 font-bold text-sm py-3">BW</div>
                        )}
                        <input key="reps" type="number" placeholder="0" value={set.r} onChange={e => setLogData(prev => ({ ...prev, [ex]: { ...prev[ex], [setId]: { ...set, r: e.target.value } } }))}
                          className="bg-slate-950 border border-slate-800 rounded-lg p-3 text-center font-bold text-white focus:border-cyan-500 outline-none transition-colors" />
                        <button onClick={() => {
                          const newSets = { ...logData[ex] };
                          delete newSets[setId];
                          setLogData(prev => ({ ...prev, [ex]: newSets }));
                        }} className="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-red-500 transition-colors">√ó</button>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>

          <div className="text-center">
            {!isAdding ? (
              <button onClick={() => setIsAdding(true)} className="w-full py-4 border-2 border-dashed border-slate-700 rounded-2xl text-slate-400 font-bold hover:border-cyan-500 hover:text-cyan-500 transition-colors">+ Add Exercise</button>
            ) : (
              <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 animate-in fade-in">
                <h3 className="font-bold text-white mb-4">Add Exercise</h3>
                <div className="flex gap-2 mb-4">
                  <button onClick={() => setNewExerciseType('weighted')} className={`flex-1 py-2 rounded-lg font-bold text-sm ${newExerciseType === 'weighted' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'}`}>Weighted</button>
                  <button onClick={() => setNewExerciseType('bodyweight')} className={`flex-1 py-2 rounded-lg font-bold text-sm ${newExerciseType === 'bodyweight' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'}`}>Bodyweight</button>
                </div>
                <input autoFocus className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 mb-4 text-white" placeholder="Exercise Name (e.g. Bench Press)" value={newExercise} onChange={e => setNewExercise(e.target.value)} />

                {/* History Suggestions */}
                {Object.keys(stats).length > 0 && (
                  <div className="mb-4 flex flex-wrap gap-2">
                    {Object.keys(stats).filter(k => k.toLowerCase().includes(newExercise.toLowerCase()) && !activeExercises.includes(k)).slice(0, 5).map(ex => (
                      <button key={ex} onClick={() => { setNewExercise(ex); setNewExerciseType(exerciseSettings?.[ex]?.type || 'weighted'); }} className="bg-slate-800 text-xs px-2 py-1 rounded text-slate-300 hover:bg-slate-700 border border-slate-700">{ex}</button>
                    ))}
                  </div>
                )}

                <div className="flex gap-3">
                  <button onClick={() => setIsAdding(false)} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-slate-400">Cancel</button>
                  <button onClick={handleAddExercise} className="flex-1 py-3 bg-cyan-600 rounded-xl font-bold text-white">Add</button>
                </div>
              </div>
            )}
          </div>

          {skippedExercises.length > 0 && (
            <div className="text-center">
              <div className="text-xs text-slate-500 uppercase mb-2">Skipped Exercises</div>
              <div className="flex flex-wrap justify-center gap-2">
                {skippedExercises.map(ex => (
                  <button key={ex} onClick={() => setSkippedExercises(prev => prev.filter(e => e !== ex))} className="bg-slate-800 px-3 py-1 rounded-lg text-xs font-bold text-slate-400 hover:bg-slate-700 hover:text-white transition-colors">+ {ex}</button>
                ))}
              </div>
            </div>
          )}

          <button onClick={finishWorkout} className="w-full py-6 rounded-2xl font-black text-2xl text-white shadow-lg shadow-cyan-900/20 hover:scale-[1.02] transition-transform" style={{ background: selected.color }}>
            Finish Workout
          </button>
        </div>
      );
    };
    const CardioTab = ({ isReady, userId, showToast, selectedDate, onSelectDate, initialData, onSave }) => {
      const [type, setType] = useState(initialData ? initialData.type : 'run');
      const [distance, setDistance] = useState(initialData ? initialData.distance : '');
      const [time, setTime] = useState(initialData ? initialData.time : '');
      const [className, setClassName] = useState(initialData ? initialData.className : '');

      useEffect(() => {
        if (initialData) {
          setType(initialData.type);
          setDistance(initialData.distance);
          setTime(initialData.time);
          setClassName(initialData.className || '');
        } else {
          setType('run');
          setDistance('');
          setTime('');
          setClassName('');
        }
      }, [initialData]);

      const logCardio = async () => {
        if (!isReady || !userId) return showToast('Database not ready.', 'error');
        if (!time) return showToast('Enter duration', 'error');
        if (type !== 'class' && !distance) return showToast('Enter distance', 'error');
        if (type === 'class' && !className) return showToast('Enter class name', 'error');

        const dist = parseFloat(distance) || 0;
        const timeMin = parseFloat(time);

        if (isNaN(timeMin) || timeMin <= 0) return showToast('Invalid duration', 'error');
        if (type !== 'class' && (isNaN(dist) || dist <= 0)) return showToast('Invalid distance', 'error');

        let calories = 0;
        if (type === 'run') calories = Math.round(dist * 100);
        else if (type === 'cycle') calories = Math.round(dist * 40);
        else if (type === 'swim') calories = Math.round(dist * 250);
        else if (type === 'hike') calories = Math.round(dist * 70);
        else if (type === 'class') calories = Math.round(timeMin * 8);

        const data = {
          date: selectedDate,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          type,
          distance: dist,
          time: timeMin,
          calories,
          className: type === 'class' ? className : null
        };

        try {
          if (initialData) {
            await DB.collection('users').doc(userId).collection('cardio_logs').doc(initialData.id).update(data);
            showToast('Activity updated!', 'success');
            if (onSave) onSave();
          } else {
            await DB.collection('users').doc(userId).collection('cardio_logs').add(data);
            setDistance(''); setTime(''); setClassName('');
            showToast('Cardio logged!', 'success');
            if (onSave) onSave();
          }
        } catch (e) {
          showToast('Logging failed. Check Security Rules.', 'error');
          console.error("Firestore Error:", e);
        }
      };

      const deleteLog = async () => {
        if (!initialData || !confirm('Delete this entry?')) return;
        try {
          await DB.collection('users').doc(userId).collection('cardio_logs').doc(initialData.id).delete();
          showToast('Entry deleted.', 'success');
          if (onSave) onSave();
        } catch (e) {
          showToast('Delete failed.', 'error');
        }
      };

      const isToday = selectedDate === getLocalISODate();
      const dateDisplay = isToday ? 'Today' : new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

      return (
        <div className="space-y-8 pb-24">
          <div className="flex items-center justify-between relative">
            <h2 className="text-2xl font-bold text-white flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors relative">
              {dateDisplay}
              <svg className="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
              <input
                type="date"
                value={selectedDate}
                onChange={(e) => onSelectDate(e.target.value)}
                className="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
              />
            </h2>
            {initialData && (
              <button onClick={deleteLog} className="text-red-500 bg-red-500/10 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500 hover:text-white transition-colors">
                Delete
              </button>
            )}
          </div>
          <div className="bg-gradient-to-br from-orange-600 to-pink-600 rounded-3xl p-8 text-center">
            <h2 className="text-4xl font-black mb-2">{initialData ? 'Edit Cardio' : 'Cardio'}</h2>
            <p className="text-white/80">{initialData ? 'Update your session details' : 'Log your runs, rides, swims, hikes...'}</p>
          </div>

          <div className="space-y-6">
            <select value={type} onChange={e => setType(e.target.value)} className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-lg font-bold border border-slate-700">
              <option value="run">Running</option>
              <option value="cycle">Cycling</option>
              <option value="swim">Swimming</option>
              <option value="hike">Hiking</option>
              <option value="class">Class (Yoga, Pilates, etc.)</option>
            </select>

            {type === 'class' ? (
              <input type="text" placeholder="Class Name (e.g. Yoga)" value={className} onChange={e => setClassName(e.target.value)}
                className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-lg font-bold border border-slate-700" />
            ) : (
              <input type="number" placeholder="Distance (km)" value={distance} onChange={e => setDistance(e.target.value)}
                className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-lg font-bold border border-slate-700" />
            )}


            <input type="number" placeholder="Time (minutes)" value={time} onChange={e => setTime(e.target.value)}
              className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-2xl font-bold text-center" />

            <div className="flex gap-3">
              {initialData && (
                <button onClick={onSave} className="flex-1 py-6 bg-slate-800 rounded-2xl font-black text-2xl text-slate-400">
                  Cancel
                </button>
              )}
              <button onClick={logCardio} className="flex-1 py-6 bg-gradient-to-r from-orange-600 to-pink-600 rounded-2xl font-black text-2xl">
                {initialData ? 'Save Changes' : 'Log Cardio'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // --- ACTIVITY TAB (HUB) ---
    const ActivityTab = ({ workouts, setWorkouts, isReady, userId, showToast, stats, setStats, selectedDate, onSelectDate, subTab, setSubTab, cardioLogs, gymLogs, editingLog, setEditingLog, exerciseSettings, setExerciseSettings }) => {
      // Filter logs for selected date
      const todaysGym = (gymLogs || []).filter(g => g.date === selectedDate);
      const todaysCardio = (cardioLogs || []).filter(c => c.date === selectedDate);
      const hasActivity = todaysGym.length > 0 || todaysCardio.length > 0;

      const handleBack = () => {
        setSubTab('list');
        setEditingLog(null);
      };

      if (subTab === 'gym') {
        return (
          <div className="animate-in fade-in">
            <button onClick={handleBack} className="mb-4 flex items-center gap-2 text-slate-400 hover:text-white transition-colors font-bold">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
              Back to Activity
            </button>
            <GymTab workouts={workouts} setWorkouts={setWorkouts} isReady={isReady} userId={userId} showToast={showToast} stats={stats} setStats={setStats} selectedDate={selectedDate} onSelectDate={onSelectDate} gymLogs={gymLogs} initialData={editingLog} onSave={handleBack} exerciseSettings={exerciseSettings} setExerciseSettings={setExerciseSettings} />
          </div>
        );
      }

      if (subTab === 'cardio') {
        return (
          <div className="animate-in fade-in">
            <button onClick={handleBack} className="mb-4 flex items-center gap-2 text-slate-400 hover:text-white transition-colors font-bold">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
              Back to Activity
            </button>
            <CardioTab key={editingLog ? editingLog.id : 'new'} isReady={isReady} userId={userId} showToast={showToast} selectedDate={selectedDate} onSelectDate={onSelectDate} cardioLogs={cardioLogs} initialData={editingLog} onSave={handleBack} />
          </div>
        );
      }

      if (subTab === 'menu') {
        return (
          <div className="animate-in fade-in">
            <button onClick={handleBack} className="mb-4 flex items-center gap-2 text-slate-400 hover:text-white transition-colors font-bold">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
              Cancel
            </button>
            <div className="grid grid-cols-1 gap-6">
              <button onClick={() => setSubTab('gym')} className="bg-slate-900/80 backdrop-blur-xl border border-slate-700 p-8 rounded-3xl flex flex-col items-center gap-4 hover:bg-slate-800 transition-all hover:scale-[1.02] group">
                <div className="text-6xl group-hover:scale-110 transition-transform">üèãÔ∏è</div>
                <div className="text-2xl font-black text-white">GYM WORKOUT</div>
                <div className="text-slate-500 text-sm font-bold">Lift weights, track sets & reps</div>
              </button>

              <button onClick={() => setSubTab('cardio')} className="bg-slate-900/80 backdrop-blur-xl border border-slate-700 p-8 rounded-3xl flex flex-col items-center gap-4 hover:bg-slate-800 transition-all hover:scale-[1.02] group">
                <div className="text-6xl group-hover:scale-110 transition-transform">üèÉ</div>
                <div className="text-2xl font-black text-white">CARDIO SESSION</div>
                <div className="text-slate-500 text-sm font-bold">Run, cycle, swim, hike, classes</div>
              </button>
            </div>
          </div>
        );
      }

      // Default: LIST View
      const isToday = selectedDate === getLocalISODate();
      const dateDisplay = isToday ? 'Today' : new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

      return (
        <div className="space-y-6 animate-in fade-in pb-24 relative min-h-[50vh]">
          <div className="flex items-center justify-between relative">
            <h2 className="text-2xl font-bold text-white flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors">
              {dateDisplay}
              <svg className="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
              <input
                type="date"
                value={selectedDate}
                onChange={(e) => onSelectDate(e.target.value)}
                className="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
              />
            </h2>
          </div>

          {!hasActivity && (
            <div className="text-center py-12 text-slate-500">
              <div className="text-6xl mb-4 grayscale opacity-30">üëü</div>
              <p className="text-lg font-bold">No activity recorded.</p>
              <p className="text-sm">Get moving and log your workout!</p>
            </div>
          )}

          <div className="space-y-4">
            {todaysGym.map(g => (
              <div key={g.id} onClick={() => { setEditingLog(g); setSubTab('gym'); }} className="bg-slate-900/80 backdrop-blur-xl p-5 rounded-2xl border-l-4 border-cyan-500 cursor-pointer hover:bg-slate-800 transition-all hover:scale-[1.01] group shadow-lg">
                <div className="flex justify-between items-start">
                  <div>
                    <div className="font-black text-lg text-white group-hover:text-cyan-400 transition-colors">{g.workoutName}</div>
                    <div className="text-sm text-slate-400 mt-1">{g.exercises.length} Exercises ‚Ä¢ {g.exercises.reduce((acc, ex) => acc + ex.sets.length, 0)} Sets</div>
                  </div>
                  <div className="bg-slate-950 p-2 rounded-lg text-2xl">üèãÔ∏è</div>
                </div>
              </div>
            ))}

            {todaysCardio.map(c => {
              const color = c.type === 'run' ? 'border-emerald-500' : c.type === 'cycle' ? 'border-amber-500' : 'border-blue-500';
              const icon = c.type === 'run' ? 'üèÉ' : c.type === 'cycle' ? 'üö¥' : 'üèä';
              return (
                <div key={c.id} onClick={() => { setEditingLog(c); setSubTab('cardio'); }} className={`bg-slate-900/80 backdrop-blur-xl p-5 rounded-2xl border-l-4 ${color} cursor-pointer hover:bg-slate-800 transition-all hover:scale-[1.01] group shadow-lg`}>
                  <div className="flex justify-between items-center">
                    <div>
                      <div className="font-black text-lg text-white capitalize group-hover:text-cyan-400 transition-colors flex items-center gap-2">
                        {c.type === 'class' ? c.className : c.type}
                      </div>
                      <div className="text-sm text-slate-400 mt-1">{c.time} mins ‚Ä¢ {c.calories} cals</div>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-black text-white">{c.distance > 0 ? c.distance : ''}<span className="text-sm text-slate-500 font-bold ml-1">{c.distance > 0 ? 'km' : ''}</span></div>
                      <div className="text-2xl">{icon}</div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <button onClick={() => setSubTab('menu')} className="fixed bottom-24 right-6 bg-gradient-to-r from-cyan-500 to-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-3xl font-light hover:scale-110 transition-transform z-50">
            Ôºã
          </button>
        </div>
      );
    };

    const FloatingMenu = ({ tab, setTab }) => {
      const [isOpen, setIsOpen] = useState(false);

      const menuItems = [
        { id: 'summary', label: 'Summary', icon: 'üìä' },
        { id: 'food', label: 'Food', icon: 'üçé' },
        { id: 'activity', label: 'Activity', icon: '‚ö°' },
      ];

      return (
        <div className="fixed bottom-6 right-6 z-[60] flex flex-col items-end gap-3">
          {isOpen && (
            <div className="flex flex-col gap-3 animate-in fade-in slide-in-from-bottom-4">
              {menuItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => { setTab(item.id); setIsOpen(false); }}
                  className={`flex items-center gap-3 px-5 py-3 rounded-full shadow-lg backdrop-blur-md border transition-all ${tab === item.id ? 'bg-cyan-500 text-white border-cyan-400' : 'bg-slate-900/90 text-slate-300 border-slate-700 hover:bg-slate-800'}`}
                >
                  <span className="text-xl">{item.icon}</span>
                  <span className="font-bold">{item.label}</span>
                </button>
              ))}
            </div>
          )}
          <button
            onClick={() => setIsOpen(!isOpen)}
            className={`w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-3xl transition-transform ${isOpen ? 'rotate-45 bg-slate-800 text-white' : 'bg-gradient-to-br from-cyan-500 to-blue-600 text-white hover:scale-105'}`}
          >
            {isOpen ? 'Ôºã' : '‚ò∞'}
          </button>
        </div>
      );
    };

    const App = () => {
      const [tab, setTab] = useState('summary');
      const [activitySubTab, setActivitySubTab] = useState('list'); // Changed default to 'list'
      const [selectedDate, setSelectedDate] = useState(getLocalISODate());
      const [calendarView, setCalendarView] = useState('week');
      const [foodLog, setFoodLog] = useState([]);
      const [gymLog, setGymLog] = useState([]);
      const [cardioLog, setCardioLog] = useState([]);
      const [workouts, setWorkouts] = useState(() => {
        const loaded = loadItem('hos_workouts', DEFAULT_WORKOUTS);
        // Merge with defaults to ensure new fields (emojis) are present
        return loaded.map(w => {
          const def = DEFAULT_WORKOUTS.find(d => d.id === w.id);
          if (def) {
            return {
              ...def, // Base on new default (has emoji)
              ...w,   // Overlay saved data (has old exercises)
              emoji: w.emoji || def.emoji, // Ensure emoji exists
              exercises: w.exercises.map(ex => typeof ex === 'string' ? { name: ex, bodyweight: false } : ex)
            };
          }
          // Custom workout
          return {
            ...w,
            exercises: w.exercises.map(ex => typeof ex === 'string' ? { name: ex, bodyweight: false } : ex)
          };
        });
      });
      const [exerciseSettings, setExerciseSettings] = useState({}); // New state for exercise metadata
      const [editingLog, setEditingLog] = useState(null); // Lifted state for activity editing
      const [stats, setStats] = useState({});
      const [toast, setToast] = useState(null);
      const [showSettings, setShowSettings] = useState(false);

      // Persistence States
      const [dbConfig] = useState(FIREBASE_CONFIG); // Hardcoded DB config
      const [isDbInitialized, setIsDbInitialized] = useState(false);
      const [userId, setUserId] = useState(null);
      const [isLoggedIn, setIsLoggedIn] = useState(false); // TRUE if permanent user
      const [connectionFailed, setConnectionFailed] = useState(false);
      const [cloudConfig, setCloudConfig] = useState(null); // Stores shared settings (e.g., GEMINI_KEY)
      const [goals, setGoals] = useState(DEFAULT_GOALS);
      const [unit, setUnit] = useState('kg');

      const isReady = isDbInitialized && userId;
      const today = getLocalISODate();

      const showToast = (msg, type = 'success') => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 3000);
      };

      // --- CLOUD CONFIGURATION MANAGEMENT ---
      const loadSharedConfig = async () => {
        if (!DB) return;
        try {
          const doc = await DB.collection('app_config').doc('shared_keys').get();
          let data = {};
          if (doc.exists) {
            data = doc.data();
          }
          setCloudConfig(data); // Set cloudConfig to data (even if empty)
          GEMINI_KEY = data.geminiKey || '';

        } catch (e) {
          console.error("Error loading shared config:", e);
          showToast('Could not load shared app settings.', 'error');
        }
      };

      const loadUserSettings = async (uid) => {
        if (!DB) return;
        try {
          const doc = await DB.collection('users').doc(uid).collection('settings').doc('profile').get();
          if (doc.exists) {
            const data = doc.data();
            if (data.goals) setGoals({ ...DEFAULT_GOALS, ...data.goals });
            if (data.unit) setUnit(data.unit);
          }

          // Load Workouts
          const workoutsDoc = await DB.collection('users').doc(uid).collection('settings').doc('workouts').get();
          if (workoutsDoc.exists) {
            setWorkouts(workoutsDoc.data().list);
          }

          // Load Stats
          const statsDoc = await DB.collection('users').doc(uid).collection('stats').doc('exercises').get();
          if (statsDoc.exists) {
            setStats(statsDoc.data());
          }

          // Load Exercise Settings
          const exSettingsDoc = await DB.collection('users').doc(uid).collection('settings').doc('exercises').get();
          if (exSettingsDoc.exists) {
            setExerciseSettings(exSettingsDoc.data());
          }
        } catch (e) {
          console.error("Error loading user settings:", e);
        }
      };

      const saveSharedConfig = async (newKey) => {
        if (!DB || !AUTH.currentUser) return;
        try {
          const configToSave = {
            // Ensure we merge with current cloudConfig in case other fields exist
            ...(cloudConfig || {}),
            geminiKey: newKey,
            updatedBy: AUTH.currentUser.email || AUTH.currentUser.uid,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          await DB.collection('app_config').doc('shared_keys').set(configToSave, { merge: true });

          await loadSharedConfig();
          showToast('Cloud settings updated!', 'success');
        } catch (e) {
          showToast('Failed to save shared settings. Check Security Rules.', 'error');
          console.error("Firestore Error:", e);
        }
      };


      // --- FIREBASE INITIALIZATION ---
      useEffect(() => {
        if (!dbConfig.projectId || typeof firebase === 'undefined') {
          const statusElement = document.getElementById('loader-status');
          if (statusElement) statusElement.innerText = 'SETUP REQUIRED';
          return;
        }

        const initializeDb = () => {
          const existingApp = firebase.apps.find(app => app.name === dbConfig.projectId);
          if (existingApp) { existingApp.delete(); }

          try {
            const app = firebase.initializeApp(dbConfig, dbConfig.projectId);
            DB = app.firestore();
            AUTH = app.auth();
            DB.settings({ timestampsInSnapshots: true });

            AUTH.onAuthStateChanged(user => {
              if (user) {
                USER_ID = user.uid;
                setUserId(USER_ID);
                setIsLoggedIn(true);
                setIsDbInitialized(true);
                setConnectionFailed(false);
                const statusEl = document.getElementById('loader-status');
                if (statusEl) statusEl.innerText = 'LOGGED IN';
                loadSharedConfig(); // CRITICAL: Load shared key first
                loadUserSettings(USER_ID); // Load personal goals
              } else {
                setUserId(null);
                setIsLoggedIn(false);
                setIsDbInitialized(true); // DB is ready, just waiting for user
                const statusEl = document.getElementById('loader-status');
                if (statusEl) statusEl.innerText = 'AWAITING LOGIN';
              }
            });
          } catch (e) {
            console.error("Firebase Init Error:", e);
            const statusElement = document.getElementById('loader-status');
            if (statusElement) statusElement.innerText = 'CONFIG ERROR';
            setConnectionFailed(true);
          }
        };

        initializeDb();
      }, [dbConfig]);

      // --- FIREBASE DATA LISTENERS ---
      useEffect(() => {
        if (!isReady) return;

        const baseRef = DB.collection('users').doc(userId);

        const unsubFood = baseRef.collection('food_logs').onSnapshot(snapshot => {
          setFoodLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || b.id) - (a.timestamp?.seconds || a.id)));
        }, (error) => {
          showToast('Food data sync failed. Check Security Rules.', 'error');
        });
        const unsubGym = baseRef.collection('gym_logs').onSnapshot(snapshot => {
          setGymLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || b.id) - (a.timestamp?.seconds || a.id)));
        });
        const unsubCardio = baseRef.collection('cardio_logs').onSnapshot(snapshot => {
          setCardioLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || b.id) - (a.timestamp?.seconds || a.id)));
        });

        return () => { unsubFood(); unsubGym(); unsubCardio(); };
      }, [isReady, userId]);

      // --- LOADER HIDE LOGIC (FAILSAFE) ---
      useEffect(() => {
        let loaderTimer;

        const hideLoader = (statusText) => {
          const loader = document.getElementById('loader');
          const root = document.getElementById('root');
          if (loader && root) {
            const statusElement = document.getElementById('loader-status');
            if (statusElement) statusElement.innerText = statusText;

            loader.style.opacity = '0';
            root.style.opacity = '1';
            setTimeout(() => loader.remove(), 700);
          }
        };

        if (isReady || connectionFailed || !dbConfig.projectId) {
          clearTimeout(loaderTimer);
          hideLoader(isReady ? 'READY' : connectionFailed ? 'ERROR' : 'SETUP REQUIRED');
        } else {
          loaderTimer = setTimeout(() => {
            setConnectionFailed(true);
          }, 5000);
        }

        return () => clearTimeout(loaderTimer);

      }, [isReady, dbConfig, connectionFailed]);


      const activeDayData = useMemo(() => {
        const food = foodLog.filter(f => f.date === selectedDate);
        const gym = gymLog.filter(g => g.date === selectedDate);
        const cardio = cardioLog.filter(c => c.date === selectedDate);

        const totals = food.reduce((a, b) => ({
          cals: a.cals + (b.cals || 0),
          prot: a.prot + (b.prot || 0),
          carb: a.carb + (b.carb || 0),
          fat: a.fat + (b.fat || 0)
        }), { cals: 0, prot: 0, carb: 0, fat: 0 });

        return { food, gym, cardio, totals, goals };
      }, [foodLog, gymLog, cardioLog, selectedDate, goals]);


      const handleSettingsSave = (newKey, msg, type) => {
        // 1. Update LOCAL/GLOBAL state immediately
        GEMINI_KEY = newKey;
        saveKey('hos_gemini_key', newKey);

        // 2. Upload to Cloud for sharing and setting Admin status
        if (AUTH.currentUser) {
          saveSharedConfig(newKey);
        }

        setShowSettings(false);
        showToast(msg, type);
      };

      const handleLogout = async () => {
        await AUTH.signOut();
        setUserId(null);
        showToast('Logged out.', 'success');
      };

      // Determine if the app is usable or blocked
      const isAppUsable = isReady;

      // CRITICAL: The app must wait until it has confirmed the cloud config state (null vs {})
      const isConfigLoaded = cloudConfig !== null;

      return (
        <div className="max-w-md mx-auto min-h-screen pb-32 px-6 pt-8">
          {toast && (
            <div className={`fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full z-50 font-bold shadow-2xl ${toast.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>
              {toast.msg}
            </div>
          )}

          {/* CONNECTION BANNER */}
          {connectionFailed && (
            <div className="bg-red-900/50 border border-red-500/50 p-3 rounded-xl mb-6 text-center text-sm text-red-300 font-bold">
              DATABASE CONNECTION FAILED. Please check settings (gear icon).
            </div>
          )}

          {/* AUTH CHECK: Show login/signup if not permanently logged in */}
          {isDbInitialized && !isLoggedIn && (
            <div className="fixed inset-0 bg-black/80 z-40 flex items-center justify-center">
              <AuthModal showToast={showToast} />
            </div>
          )}

          {/* SETTINGS MODAL */}
          <SettingsModal
            isVisible={showSettings}
            onClose={() => setShowSettings(false)}
            onSave={handleSettingsSave}
            currentKey={GEMINI_KEY}
            goals={goals}
            setGoals={setGoals}
            calendarView={calendarView}
            setCalendarView={setCalendarView}
          />

          {/* MAIN UI (BLOCKED IF NOT LOGGED IN) */}
          <div className={!isAppUsable ? 'opacity-20 pointer-events-none' : ''}>
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-5xl font-black">{tab === 'food' ? 'FOOD' : tab === 'activity' ? 'ACTIVITY' : 'SUMMARY'}</h1>

              <div className="flex items-center space-x-3">
                {isLoggedIn && (
                  <button onClick={handleLogout} className="p-2 bg-slate-800 rounded-full text-red-400 hover:bg-slate-700 text-sm">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                  </button>
                )}
                <button onClick={() => setShowSettings(true)} className="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
              </div>
            </div>

            <div className="pb-24">
              {tab === 'summary' && <SummaryTab
                data={activeDayData}
                allFood={foodLog}
                allGym={gymLog}
                allCardio={cardioLog}
                selectedDate={selectedDate}
                onSelectDate={setSelectedDate}
                calendarView={calendarView}
                onNavigate={setTab}
                onSubNavigate={setActivitySubTab}
                onSetEditingLog={setEditingLog}
              />}

              {tab === 'food' && <FoodTab
                data={activeDayData}
                isReady={isReady}
                userId={userId}
                showToast={showToast}
                isConfigLoaded={isConfigLoaded}
                selectedDate={selectedDate}
                onSelectDate={setSelectedDate}
              />}

              {tab === 'activity' && <ActivityTab
                workouts={workouts}
                setWorkouts={setWorkouts}
                isReady={isReady}
                userId={userId}
                showToast={showToast}
                stats={stats}
                setStats={setStats}
                selectedDate={selectedDate}
                onSelectDate={setSelectedDate}
                subTab={activitySubTab}
                setSubTab={setActivitySubTab}
                cardioLogs={cardioLog}
                gymLogs={gymLog}
                editingLog={editingLog}
                setEditingLog={setEditingLog}
                exerciseSettings={exerciseSettings}
                setExerciseSettings={setExerciseSettings}
              />}  </div>


            <FloatingMenu tab={tab} setTab={setTab} />
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>