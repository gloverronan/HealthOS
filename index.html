<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">
  <title>Health OS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } } }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- FIXED Firebase compat (this order + version is the only one that reliably works in 2025) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { background: #020617; color: white; overscroll-behavior: none; }
    #loader { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.7s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="min-h-screen">

<div id="loader">
  <div class="text-center">
    <div class="w-16 h-16 border-4 border-slate-800 border-t-cyan-500 rounded-full animate-spin mb-6"></div>
    <div class="text-3xl font-black tracking-tighter">Health OS</div>
    <div class="text-sm text-slate-500 mt-2 tracking-widest">LOADING...</div>
  </div>
</div>

<div id="root" class="opacity-0 transition-opacity duration-700"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

// LocalStorage helpers
const loadItem = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) || def; } catch { return def; } };
const saveItem = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const loadKey = (k) => { try { return localStorage.getItem(k) || ''; } catch { return ''; } };
const saveKey = (k, v) => { try { localStorage.setItem(k, v); } catch {} };

// Config
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBUiU8DmIgQH843AqqM4oiK22i4p2UJdp0",
  authDomain: "healthos-3d23f.firebaseapp.com",
  projectId: "healthos-3d23f",
  appId: "1:1071494735916:web:65d641926c7511ee5c4989",
};

const GOALS = { calories: 2350, protein: 180, carbs: 250 };
let GEMINI_KEY = loadKey('hos_gemini_key');

const DEFAULT_WORKOUTS = [
  { id: "push", name: "Push", color: "#ec4899", exercises: ["Bench Press", "Overhead Press", "Tricep Extensions"] },
  { id: "legs", name: "Legs", color: "#3b82f6", exercises: ["Squat", "Romanian Deadlift", "Calf Raises"] },
  { id: "pull", name: "Pull", color: "#10b981", exercises: ["Pull-ups", "Barbell Row", "Bicep Curls"] }
];

let DB = null;
let AUTH = null;

// Activity Rings
const ActivityRings = ({ cals, prot, carb }) => {
  const pct = (v, g) => Math.min(100, (v / g) * 100);
  const Ring = ({ r, progress, color }) => {
    const circum = 2 * Math.PI * r;
    const dash = (progress / 100) * circum;
    return <circle cx="128" cy="128" r={r} stroke={color} strokeWidth="14" fill="none" strokeDasharray={circum} strokeDashoffset={circum - dash} strokeLinecap="round" className="-rotate-90 transition-all duration-1000" style={{ filter: `drop-shadow(0 0 8px ${color})` }} />;
  };

  return (
    <div className="relative w-64 h-64 mx-auto mb-8">
      <svg viewBox="0 0 256 256">
        <circle cx="128" cy="128" r="110" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3"/>
        <circle cx="128" cy="128" r="90" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3"/>
        <circle cx="128" cy="128" r="70" stroke="#1e293b" strokeWidth="14" fill="none" opacity="0.3"/>
        <Ring r={110} progress={pct(cals, GOALS.calories)} color="#10b981" />
        <Ring r={90} progress={pct(prot, GOALS.protein)} color="#3b82f6" />
        <Ring r={70} progress={pct(carb, GOALS.carbs)} color="#f59e0b" />
      </svg>
      <div className="absolute inset-0 flex items-center justify-center text-center">
        <div>
          <div className="text-5xl font-black">{cals || 0}</div>
          <div className="text-xs text-slate-500 uppercase tracking-widest">Calories</div>
        </div>
      </div>
    </div>
  );
};

// Auth Modal
const AuthModal = ({ showToast }) => {
  const [mode, setMode] = useState('login');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const submit = async () => {
    if (!email || !password) return setError('Email and password required');
    setLoading(true); setError('');
    try {
      if (mode === 'signup') await AUTH.createUserWithEmailAndPassword(email, password);
      else await AUTH.signInWithEmailAndPassword(email, password);
      showToast('Logged in successfully!', 'success');
    } catch (e) {
      setError(e.message.replace('Firebase: ', ''));
    } finally {
      setLoading(false);
    }
  };

  const google = async () => {
    setLoading(true);
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await AUTH.signInWithPopup(provider);
    } catch (e) {
      if (e.code !== 'auth/popup-closed-by-user') setError('Google sign-in failed');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md">
      <div className="bg-slate-900/90 border border-slate-700 p-8 rounded-2xl w-full max-w-sm shadow-2xl">
        <h3 className="text-3xl font-black mb-8 text-center">{mode === 'login' ? 'Log In' : 'Create Account'}</h3>
        {error && <div className="bg-red-600/20 text-red-400 p-3 rounded-lg mb-4 text-sm">{error}</div>}
        <button onClick={google} disabled={loading} className="w-full py-4 rounded-xl font-bold bg-slate-800 hover:bg-slate-700 mb-4 disabled:opacity-50">
          {loading ? '...' : 'Sign in with Google'}
        </button>
        <div className="text-center text-xs text-slate-600 mb-4 uppercase tracking-widest">or</div>
        <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-slate-800 p-4 rounded-xl mb-3 border border-slate-700 outline-none" />
        <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-slate-800 p-4 rounded-xl mb-6 border border-slate-700 outline-none" />
        <button onClick={submit} disabled={loading} className="w-full py-4 rounded-xl font-bold bg-cyan-600 hover:bg-cyan-500 disabled:opacity-50">
          {loading ? 'Processing...' : mode === 'login' ? 'Log In' : 'Create Account'}
        </button>
        <button onClick={() => setMode(mode === 'login' ? 'signup' : 'login')} className="w-full mt-4 text-sm text-slate-400 hover:text-white">
          {mode === 'login' ? "Don't have an account? Sign Up" : "Already have an account? Log In"}
        </button>
      </div>
    </div>
  );
};

// Settings Modal (Gemini key)
const SettingsModal = ({ visible, onClose, showToast }) => {
  const [key, setKey] = useState(GEMINI_KEY);
  const [checking, setChecking] = useState(false);

  const verifyAndSave = async () => {
    if (!key.trim()) return alert('Key empty');
    setChecking(true);
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: "test" }] }] })
      });
      if (res.ok) {
        await DB.collection('app_config').doc('shared_keys').set({ geminiKey: key }, { merge: true });
        GEMINI_KEY = key;
        saveKey('hos_gemini_key', key);
        showToast('Gemini key saved & shared with everyone!', 'success');
        onClose();
      } else throw new Error();
    } catch {
      alert('Invalid or rate-limited Gemini key');
    } finally {
      setChecking(false);
    }
  };

  if (!visible) return null;

  return (
    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md" onClick={onClose}>
      <div className="bg-slate-900/90 border border-slate-700 p-8 rounded-2xl w-full max-w-md shadow-2xl" onClick={e => e.stopPropagation()}>
        <h3 className="text-2xl font-black mb-6">Gemini API Key (shared)</h3>
        <input type="password" value={key} onChange={e => setKey(e.target.value)} placeholder="sk-..." className="w-full bg-slate-950 p-4 rounded-xl border border-slate-700 mb-6 focus:border-cyan-500 outline-none" />
        <button onClick={verifyAndSave} disabled={checking} className="w-full py-4 bg-cyan-600 rounded-xl font-bold hover:bg-cyan-500 disabled:opacity-50">
          {checking ? 'Verifying...' : 'Verify & Save for Everyone'}
        </button>
        <p className="text-xs text-slate-500 mt-4">Only you (admin) can change this key after the first save.</p>
        <button onClick={onClose} className="w-full mt-6 text-slate-400 text-sm">Close</button>
      </div>
    </div>
  );
};
  
const SummaryTab = ({ data, allFood, allGym, allCardio }) => {
  const dates = useMemo(() => {
    const uniqueDates = [...new Set([...allFood.map(f => f.date), ...allGym.map(g => g.date), ...allCardio.map(c => c.date)])];
    return uniqueDates.filter(d => d).sort().reverse();
  }, [allFood, allGym, allCardio]);

  return (
    <div className="space-y-8">
      <div className="text-center">
        <div className="text-3xl font-black mb-2">{data.totals.cals} cal</div>
        <div className="text-sm text-slate-500">{data.totals.prot}g P • {data.totals.carb}g C</div>
      </div>
      <ActivityRings {...data.totals} />

      <div className="space-y-6">
        {dates.map(date => {
          const dayFood = allFood.filter(f => f.date === date);
          const dayGym = allGym.filter(g => g.date === date);
          const dayCardio = allCardio.filter(c => c.date === date);

          return (
            <div key={date} className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
              <div className="text-lg font-bold mb-4">{new Date(date).toLocaleDateString('en', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
              {dayFood.length > 0 && <div className="mb-4"><div className="text-xs text-slate-500 uppercase mb-2">Food</div>{dayFood.map(f => <div key={f.id} className="text-sm">• {f.name} ({f.cals} cal)</div>)}</div>}
              {dayGym.length > 0 && <div className="mb-4"><div className="text-xs text-slate-500 uppercase mb-2">Gym</div>{dayGym.map(g => <div key={g.id} className="text-sm">• {g.workoutName}</div>)}</div>}
              {dayCardio.length > 0 && <div><div className="text-xs text-slate-500 uppercase mb-2">Cardio</div>{dayCardio.map(c => <div key={c.id} className="text-sm">• {c.type} – {c.distance}km in {c.time} min</div>)}</div>}
            </div>
          );
        })}
      </div>
    </div>
  );
};

const GeminiFoodEntry = ({ isReady, userId, showToast }) => {
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const today = new Date().toISOString().split('T')[0];

  const analyze = async () => {
    if (!input.trim()) return;
    if (!GEMINI_KEY) return showToast('Set Gemini key in Settings first', 'error');
    setLoading(true);
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Return ONLY valid JSON (no markdown): {"name":"string","cals":number,"prot":number,"carb":number,"fat":number}. Food: ${input}` }] }]
        })
      });
      
      const data = await res.json();
      const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (!responseText) throw new Error('Empty response');
      
      const jsonString = responseText.trim().replace(/```json|```/g, '');
      const json = JSON.parse(jsonString);
      setResult(json);

    } catch (e) {
      showToast('Gemini failed – check key or try again', 'error');
      console.error(e);
    }
    setLoading(false);
  };

  const add = async () => {
    if (!result || !isReady || !userId) return;
    try {
      await DB.collection(`users/${userId}/food`).add({
        date: today,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        name: result.name,
        cals: Number(result.cals) || 0,
        prot: Number(result.prot) || 0,
        carb: Number(result.carb) || 0,
        fat: Number(result.fat) || 0
      });
      setInput(''); setResult(null);
      showToast('Food logged!', 'success');
    } catch (e) {
      showToast('Save failed', 'error');
    }
  };

  return (
    <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-6 mb-8 border border-slate-700">
      <div className="flex gap-3 mb-4">
        <input className="flex-1 bg-slate-950/70 border border-slate-700 rounded-xl px-5 py-4 text-lg placeholder-slate-500 focus:border-emerald-500 transition" 
               placeholder="Large pepperoni pizza, 2 eggs + avocado toast..." value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && analyze()} />
        <button onClick={analyze} disabled={loading} className="bg-emerald-600 px-8 rounded-xl font-bold disabled:opacity-50 hover:bg-emerald-500">
          {loading ? '...' : 'AI'}
        </button>
      </div>
      {result && (
        <div className="space-y-4 animate-in fade-in">
          <input className="w-full bg-transparent text-xl font-bold outline-none border-b border-slate-600" value={result.name} onChange={e => setResult({...result, name: e.target.value})} />
          <div className="grid grid-cols-4 gap-4">
            {['cals','prot','carb','fat'].map(k => (
              <input key={k} type="number" className="bg-slate-950/70 rounded-lg p-3 text-center text-xl font-bold" 
                     value={result[k]} onChange={e => setResult({...result, [k]: e.target.value})} />
            ))}
          </div>
          <button onClick={add} className="w-full bg-emerald-600 py-4 rounded-xl font-bold text-lg">Add to Today</button>
        </div>
      )}
    </div>
  );
};

const FoodTab = ({ data, isReady, userId, showToast }) => {
  const deleteFoodItem = async (docId) => {
    try {
      await DB.collection(`users/${userId}/food_logs/logs`).doc(docId).delete();
      showToast('Deleted', 'success');
    } catch {
      showToast('Delete failed', 'error');
    }
  };

  return (
    <>
      <ActivityRings {...data.totals} />
      <GeminiFoodEntry isReady={isReady} userId={userId} showToast={showToast} />
      <div className="space-y-4">
        {data.food.map(item => (
          <div key={item.id} className="bg-slate-900/80 backdrop-blur-xl rounded-xl p-5 flex justify-between items-center border border-slate-700">
            <div>
              <div className="font-bold">{item.name}</div>
              <div className="text-sm text-slate-500">{item.prot}g P • {item.carb}g C • {item.fat}g F</div>
            </div>
            <div className="text-right flex items-center gap-4">
              <div className="text-2xl font-black text-emerald-400">{item.cals}</div>
              <button onClick={() => deleteFoodItem(item.id)} className="text-red-500 text-lg">×</button>
            </div>
          </div>
        ))}
      </div>
    </>
  );
};

const GymTab = ({ workouts, setWorkouts, isReady, userId, showToast }) => {
  const [selected, setSelected] = useState(workouts[0]);
  const [logData, setLogData] = useState({});
  const today = new Date().toISOString().split('T')[0];

  const finishWorkout = async () => {
    const loggedExercises = Object.entries(logData).map(([ex, sets]) => ({
      exercise: ex,
      sets: Object.values(sets).filter(s => s.w && s.r).map(s => ({ weight: parseFloat(s.w), reps: parseInt(s.r) }))
    })).filter(e => e.sets.length > 0);

    if (loggedExercises.length === 0) return showToast('Add at least one set', 'error');

    try {
      await DB.collection(`users/${userId}/gym`).add({ 
        date: today, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        workoutName: selected.name, 
        exercises: loggedExercises 
      });
      setLogData({});
      showToast('Workout logged!', 'success');
    } catch {
      showToast('Save failed', 'error');
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex overflow-x-auto gap-4 pb-4 no-scrollbar">
        {workouts.map(w => (
          <button key={w.id} onClick={() => setSelected(w)} 
                  className={`px-6 py-3 rounded-full font-bold transition-all ${selected.id === w.id ? 'bg-white text-black' : 'bg-slate-800'}`}>
            {w.name}
          </button>
        ))}
      </div>

      {selected.exercises.map(ex => (
        <div key={ex} className="bg-slate-900/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-bold text-xl">{ex}</h3>
            <button onClick={() => setLogData(prev => ({ ...prev, [ex]: { ...prev[ex], [Date.now()]: { w: '', r: '' } } }))}
                    className="text-cyan-400 text-2xl">+</button>
          </div>
          <div className="space-y-3">
            {Object.entries(logData[ex] || {}).map(([id, set]) => (
              <div key={id} className="flex gap-3">
                <input type="number" placeholder="kg" className="flex-1 bg-slate-950/70 rounded-lg px-4 py-3 text-center font-bold"
                       value={set.w} onChange={e => setLogData(prev => ({ ...prev, [ex]: { ...prev[ex], [id]: { ...set, w: e.target.value } } }))} />
                <input type="number" placeholder="reps" className="w-24 bg-slate-950/70 rounded-lg px-4 py-3 text-center font-bold"
                       value={set.r} onChange={e => setLogData(prev => ({ ...prev, [ex]: { ...prev[ex], [id]: { ...set, r: e.target.value } } }))} />
                <button onClick={() => setLogData(prev => { const newEx = { ...prev[ex] }; delete newEx[id]; return { ...prev, [ex]: newEx }; })}
                        className="text-red-500">×</button>
              </div>
            ))}
            {(!logData[ex] || Object.keys(logData[ex]).length === 0) && (
              <button onClick={() => setLogData(prev => ({ ...prev, [ex]: { [Date.now()]: { w: '', r: '' } } }))}
                      className="w-full py-4 border-2 border-dashed border-slate-600 rounded-xl text-slate-400">
                + Add Set
              </button>
            )}
          </div>
        </div>
      ))}

      <button onClick={finishWorkout} className="w-full py-6 rounded-2xl font-black text-2xl text-white" style={{ background: selected.color }}>
        Finish Workout
      </button>
    </div>
  );
};

const CardioTab = ({ isReady, userId, showToast }) => {
  const [type, setType] = useState('run');
  const [distance, setDistance] = useState('');
  const [time, setTime] = useState('');
  const today = new Date().toISOString().split('T')[0];

  const logCardio = async () => {
    if (!distance || !time) return showToast('Fill all fields', 'error');
    const dist = parseFloat(distance);
    const mins = parseFloat(time);
    if (isNaN(dist) || isNaN(mins) || dist <= 0 || mins <= 0) return showToast('Invalid numbers', 'error');

    const calories = type === 'run' ? Math.round(dist * 100) : type === 'cycle' ? Math.round(dist * 40) : Math.round(dist * 60);

    try {
      await DB.collection(`users/${userId}/cardio`).add({ 
        date: today, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        type, distance: dist, time: mins, calories 
      });
      setDistance(''); setTime('');
      showToast('Cardio logged!', 'success');
    } catch {
      showToast('Save failed', 'error');
    }
  };

  return (
    <div className="space-y-8">
      <div className="bg-gradient-to-br from-orange-600 to-pink-600 rounded-3xl p-8 text-center">
        <h2 className="text-4xl font-black mb-2">Cardio</h2>
        <p className="text-white/80">Log your runs, rides, swims...</p>
      </div>

      <div className="space-y-6">
        <select value={type} onChange={e => setType(e.target.value)} className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-lg font-bold">
          <option value="run">Running</option>
          <option value="cycle">Cycling</option>
          <option value="swim">Swimming</option>
          <option value="other">Other</option>
        </select>

        <input type="number" placeholder="Distance (km)" value={distance} onChange={e => setDistance(e.target.value)}
               className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-2xl font-bold text-center" />

        <input type="number" placeholder="Time (minutes)" value={time} onChange={e => setTime(e.target.value)}
               className="w-full bg-slate-900/80 rounded-xl px-6 py-4 text-2xl font-bold text-center" />

        <button onClick={logCardio} className="w-full py-6 bg-gradient-to-r from-orange-600 to-pink-600 rounded-2xl font-black text-2xl">
          Log Cardio
        </button>
      </div>
    </div>
  );
};

// ==================== MAIN APP ====================
const App = () => {
  const [tab, setTab] = useState('summary');
  const [foodLog, setFoodLog] = useState([]);
  const [gymLog, setGymLog] = useState([]);
  const [cardioLog, setCardioLog] = useState([]);
  const [workouts, setWorkouts] = useState(loadItem('hos_workouts', DEFAULT_WORKOUTS));
  const [toast, setToast] = useState(null);
  const [showAuth, setShowAuth] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [userId, setUserId] = useState(null);

  const today = new Date().toISOString().split('T')[0];

  const showToast = (msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  // Firebase init + auth observer
  useEffect(() => {
    const app = firebase.initializeApp(FIREBASE_CONFIG);
    AUTH = firebase.auth();
    DB = firebase.firestore();

    const unsub = AUTH.onAuthStateChanged(user => {
      setUserId(user ? user.uid : null);
      setShowAuth(!user);

      // Load shared Gemini key when logged in
      if (user) {
        DB.collection('app_config').doc('shared_keys').get().then(doc => {
          if (doc.exists && doc.data().geminiKey) {
            GEMINI_KEY = doc.data().geminiKey;
            saveKey('hos_gemini_key', GEMINI_KEY);
          }
        });
      }

      // Always hide loader once Firebase is ready
      document.getElementById('loader').style.opacity = '0';
      document.getElementById('root').style.opacity = '1';
      setTimeout(() => document.getElementById('loader')?.remove(), 800);
    });

    return unsub;
  }, []);

    // Real-time listeners – FLAT STRUCTURE (fixes the error forever)
  useEffect(() => {
    if (!userId) return;

    const unsubs = [
      DB.collection(`users/${userId}/food`).onSnapshot(snap => 
        setFoodLog(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })))
      ),
      DB.collection(`users/${userId}/gym`).onSnapshot(snap => 
        setGymLog(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })))
      ),
      DB.collection(`users/${userId}/cardio`).onSnapshot(snap => 
        setCardioLog(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })))
      )
    ];

    return () => unsubs.forEach(u => u());
  }, [userId]);

  const todaysData = useMemo(() => {
    const food = foodLog.filter(f => f.date === today);
    const totals = food.reduce((a, b) => ({
      cals: a.cals + (b.cals || 0),
      prot: a.prot + (b.prot || 0),
      carb: a.carb + (b.carb || 0)
    }), { cals: 0, prot: 0, carb: 0 });

    return {
      food,
      gym: gymLog.filter(g => g.date === today),
      cardio: cardioLog.filter(c => c.date === today),
      totals
    };
  }, [foodLog, gymLog, cardioLog, today]);

  return (
    <div className="max-w-md mx-auto min-h-screen pb-32 px-6 pt-8 relative">
      {toast && (
        <div className={`fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full font-bold z-50 shadow-2xl ${toast.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>
          {toast.msg}
        </div>
      )}

      {showAuth && <AuthModal showToast={showToast} />}
      <SettingsModal visible={showSettings} onClose={() => setShowSettings(false)} showToast={showToast} />

      <div className={!userId ? 'opacity-30 pointer-events-none' : ''}>
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-5xl font-black">{tab === 'summary' ? 'SUMMARY' : tab.toUpperCase()}</h1>
          <div className="flex gap-3">
            <button onClick={() => AUTH.signOut()} className="p-2 bg-slate-800 rounded-full text-red-400 text-sm">Logout</button>
            <button onClick={() => setShowSettings(true)} className="p-3 bg-slate-800 rounded-full">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
          </div>
        </div>

        {tab === 'summary' && <SummaryTab data={todaysData} allFood={foodLog} allGym={gymLog} allCardio={cardioLog} />}
        {tab === 'food' && <FoodTab data={todaysData} isReady={!!userId} userId={userId} showToast={showToast} />}
        {tab === 'gym' && <GymTab workouts={workouts} setWorkouts={setWorkouts} isReady={!!userId} userId={userId} showToast={showToast} />}
        {tab === 'cardio' && <CardioTab isReady={!!userId} userId={userId} showToast={showToast} />}

        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-2xl border border-slate-800 rounded-full shadow-2xl flex z-50">
          <button onClick={() => setTab('summary')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'summary' ? 'bg-cyan-600 text-white' : 'text-slate-500'}`}>Summary</button>
          <button onClick={() => setTab('food')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'food' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>Food</button>
          <button onClick={() => setTab('gym')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'gym' ? 'bg-pink-600 text-white' : 'text-slate-500'}`}>Gym</button>
          <button onClick={() => setTab('cardio')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'cardio' ? 'bg-orange-600 text-white' : 'text-slate-500'}`}>Cardio</button>
        </div>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
