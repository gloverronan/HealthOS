<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Health OS v-Stable</title>

    <!-- WORKING Tailwind CSS v3 via CDN (the only reliable way for pure static HTML) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #020617; color: white; font-family: -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-box { background-color: #1e293b; border: 1px solid #334155; border-radius: 12px; text-align: center; color: white; font-weight: 600; font-size: 16px; width: 100%; height: 44px; outline: none; }
        #loader { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
    </style>
</head>
<body class="min-h-screen">

    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-slate-700 border-t-cyan-500 rounded-full animate-spin mb-4"></div>
            <div class="text-slate-500 font-bold text-sm tracking-widest uppercase">Health OS</div>
        </div>
    </div>

    <div id="root" style="opacity: 0; transition: opacity 0.5s;"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIG & UTILS ---
        const SAFE_LOAD = (k, d) => { try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : d; } catch(e) { return d; } };
        const SAFE_SAVE = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} };

        const GOALS = { calories: 2350, protein: 180, carbs: 250 };
        const COLOR_MAP = { '#f43f5e': 'rose-500', '#3b82f6': 'blue-500', '#10b981': 'emerald-500' };
        const INIT_DAYS = [
            { day: 'Day 1', name: 'Push', color: '#f43f5e', exercises: ['Bench Press', 'Overhead Press', 'Triceps Ext'] },
            { day: 'Day 3', name: 'Legs', color: '#3b82f6', exercises: ['Squats', 'RDLs', 'Calf Raises'] },
            { day: 'Day 5', name: 'Pull', color: '#10b981', exercises: ['Rows', 'Lat Pulldowns', 'Curls'] }
        ];

        let apiKey = SAFE_LOAD('hos_api_key', '');

        // --- ICONS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const paths = {
                History: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
                Settings: "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z",
                Back: "M15 19l-7-7 7-7",
                Trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
                Plus: "M12 4v16m8-8H4",
                Minus: "M20 12H4",
                ChevronUp: "M5 15l7-7 7 7",
                ChevronDown: "M19 9l-7 7-7-7"
            };
            return (
                <svg className={`w-${size/4} h-${size/4} ${className}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={paths[name] || ""} />
                </svg>
            );
        };

        // --- ACTIVITY RINGS ---
        const ActivityRings = ({ cals, calsT, prot, protT, carbs, carbsT }) => {
            const Ring = ({ r, current, target, color, bg }) => {
                const circum = 2 * Math.PI * r;
                const pct = Math.min(100, Math.max(0, (current / target) * 100));
                const offset = circum - (pct / 100) * circum;

                return (
                    <g>
                        <circle cx="60" cy="60" r={r} stroke={bg} strokeWidth="10" fill="none" opacity="0.2" />
                        <circle cx="60" cy="60" r={r} stroke={color} strokeWidth="10" fill="none"
                                strokeDasharray={circum} strokeDashoffset={offset} strokeLinecap="round"
                                className="origin-center -rotate-90 transition-all duration-1000 ease-out"
                                style={{ filter: `drop-shadow(0 0 6px ${color})` }} />
                    </g>
                );
            };

            return (
                <div className="flex items-center justify-between bg-slate-900 p-5 rounded-2xl shadow-lg mb-6 border border-slate-800">
                    <div className="space-y-3 z-10 flex-1">
                        {[
                            { l: 'Calories', v: cals, t: calsT, col: '#10b981' },
                            { l: 'Protein', v: prot, t: protT, col: '#3b82f6' },
                            { l: 'Carbs', v: carbs, t: carbsT, col: '#f97316' }
                        ].map(x => (
                            <div key={x.l}>
                                <div className="text-[10px] font-bold uppercase tracking-wider opacity-70" style={{ color: x.col }}>{x.l}</div>
                                <div className="text-2xl font-black text-white">{x.v} <span className="text-slate-600 text-sm font-medium">/ {x.t}</span></div>
                            </div>
                        ))}
                    </div>
                    <div className="relative w-32 h-32 flex-shrink-0">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <Ring r={50} current={cals} target={calsT} color="#10b981" bg="#064e3b" />
                            <Ring r={38} current={prot} target={protT} color="#3b82f6" bg="#1e3a8a" />
                            <Ring r={26} current={carbs} target={carbsT} color="#f97316" bg="#7c2d12" />
                        </svg>
                    </div>
                </div>
            );
        };

        // --- GYM TRACKER ---
        const GymTracker = ({ showFeedback }) => {
            const [days, setDays] = useState(() => SAFE_LOAD('hos_workouts', INIT_DAYS));
            const [logs, setLogs] = useState(() => SAFE_LOAD('hos_gym_logs', []));
            const [setCounts, setSetCounts] = useState(() => SAFE_LOAD('hos_sets', {}));
            const [idx, setIdx] = useState(0);
            const [input, setInput] = useState({});
            const [isEdit, setIsEdit] = useState(false);
            const [newEx, setNewEx] = useState('');

            useEffect(() => {
                SAFE_SAVE('hos_workouts', days);
                SAFE_SAVE('hos_gym_logs', logs);
                SAFE_SAVE('hos_sets', setCounts);
            }, [days, logs, setCounts]);

            const day = days[idx] || days[0];
            const themeHex = day.color || '#3b82f6';
            const themeClass = COLOR_MAP[themeHex] || 'cyan-500';

            const updateSetCount = (ex, delta) => setSetCounts(prev => ({
                ...prev,
                [ex]: Math.max(1, Math.min(8, (prev[ex] || 3) + delta))
            }));

            const logWorkout = () => {
                const exercises = Object.entries(input).reduce((acc, [name, sets]) => {
                    const validSets = Object.values(sets || {})
                        .map((s, i) => ({ set: i + 1, weight: Number(s.w) || 0, reps: Number(s.r) || 0 }))
                        .filter(s => s.weight > 0 || s.reps > 0);
                    if (validSets.length) acc.push({ exerciseName: name, sets: validSets });
                    return acc;
                }, []);

                if (!exercises.length) return showFeedback('Log at least one set', 'error');

                setLogs([{ id: Date.now(), date: new Date().toLocaleDateString(), dayName: day.name, color: day.color, exercises }, ...logs]);
                setInput({});
                showFeedback('Workout Saved!', 'success');
            };

            return (
                <div className="space-y-6 pb-20">
                    {/* Header */}
                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl text-center">
                        <div className="flex items-center justify-between mb-4">
                            <button onClick={() => setIdx((idx - 1 + days.length) % days.length)} className="text-4xl text-slate-500 hover:text-white">‹</button>
                            <div>
                                <input className={`bg-transparent text-3xl font-black text-center w-full outline-none text-${themeClass}`} value={day.name}
                                    onChange={e => { const d = [...days]; d[idx].name = e.target.value; setDays(d); }} />
                                <div className="text-xs text-slate-500 font-bold uppercase tracking-widest">{day.day}</div>
                            </div>
                            <button onClick={() => setIdx((idx + 1) % days.length)} className="text-4xl text-slate-500 hover:text-white">›</button>
                        </div>
                        <button onClick={() => setIsEdit(!isEdit)} className="text-xs font-bold py-2 px-5 rounded-full bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white">
                            {isEdit ? 'Done Editing' : 'Edit Routine'}
                        </button>
                    </div>

                    {/* Exercises */}
                    {day.exercises.map((ex, i) => {
                        const numSets = setCounts[ex] || 3;
                        return (
                            <div key={ex + i} className="bg-slate-900 p-5 rounded-2xl border border-slate-800 shadow-lg">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-xl">{ex}</h3>
                                    {isEdit ? (
                                        <button onClick={() => {
                                            const d = [...days];
                                            d[idx].exercises = d[idx].exercises.filter(e => e !== ex);
                                            setDays(d);
                                        }} className="text-red-500 p-2">
                                            <Icon name="Trash" size={20} />
                                        </button>
                                    ) : (
                                        <div className="flex items-center gap-3 bg-slate-950/50 px-3 py-1 rounded-lg">
                                            <button onClick={() => updateSetCount(ex, -1)}><Icon name="Minus" size={18} className="text-slate-400" /></button>
                                            <span className="text-sm font-bold w-6 text-center">{numSets}</span>
                                            <button onClick={() => updateSetCount(ex, 1)}><Icon name="Plus" size={18} className="text-slate-400" /></button>
                                        </div>
                                    )}
                                </div>

                                {!isEdit && (
                                    <div className="flex gap-3 overflow-x-auto no-scrollbar pb-3">
                                        {[...Array(numSets)].map((_, s) => (
                                            <div key={s} className="flex flex-col gap-2 min-w-[100px]">
                                                <div className="text-center text-[10px] text-slate-500 font-bold uppercase">Set {s + 1}</div>
                                                <input type="number" placeholder="kg" className="input-box" style={{ borderColor: input[ex]?.[s]?.w ? themeHex : '#334155', color: input[ex]?.[s]?.w ? themeHex : 'white' }}
                                                    value={input[ex]?.[s]?.w || ''} onChange={e => setInput(prev => ({ ...prev, [ex]: { ...prev[ex], [s]: { ...prev[ex]?.[s], w: e.target.value } } }))} />
                                                <input type="number" placeholder="reps" className="input-box" style={{ borderColor: input[ex]?.[s]?.r ? themeHex : '#334155', color: input[ex]?.[s]?.r ? themeHex : 'white' }}
                                                    value={input[ex]?.[s]?.r || ''} onChange={e => setInput(prev => ({ ...prev, [ex]: { ...prev[ex], [s]: { ...prev[ex]?.[s], r: e.target.value } } }))} />
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    })}

                    {isEdit && (
                        <div className="flex gap-3">
                            <input className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 text-white" placeholder="New exercise..." value={newEx} onChange={e => setNewEx(e.target.value)} />
                            <button onClick={() => { if (newEx.trim()) { const d = [...days]; d[idx].exercises.push(newEx.trim()); setDays(d); setNewEx(''); } }}
                                className={`bg-${themeClass} px-6 rounded-xl font-bold text-white text-2xl`}>+</button>
                        </div>
                    )}

                    {!isEdit && (
                        <button onClick={logWorkout}
                            className={`w-full py-5 rounded-2xl font-black text-lg uppercase tracking-wider text-white bg-${themeClass}`}
                            style={{ boxShadow: `0 20px 40px -10px ${themeHex}60` }}>
                            Finish Workout
                        </button>
                    )}
                </div>
            );
        };

        // --- FOOD TRACKER (unchanged except tiny fixes) ---
        const FoodTracker = ({ showFeedback }) => {
            const [logs, setLogs] = useState(() => SAFE_LOAD('hos_food_logs', []));
            const [input, setInput] = useState({ name: '', cals: '', prot: '', carb: '', fat: '' });
            const [raw, setRaw] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => SAFE_SAVE('hos_food_logs', logs), [logs]);

            const today = new Date().toLocaleDateString();
            const totals = logs.filter(l => l.date === today).reduce((a, b) => ({
                cals: a.cals + (b.cals || 0),
                p: a.p + (b.prot || 0),
                c: a.c + (b.carb || 0),
                f: a.f + (b.fat || 0)
            }), { cals: 0, p: 0, c: 0, f: 0 });

            const getMeal = (h) => {
                if (h >= 5 && h < 11) return 'Breakfast';
                if (h >= 11 && h < 16) return 'Lunch';
                if (h >= 16 && h < 22) return 'Dinner';
                return 'Snacks';
            };

            const callGemini = async () => {
                if (!apiKey) return showFeedback('Set your Gemini API key first', 'error');
                if (!raw.trim()) return;
                setLoading(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Return ONLY valid JSON for this food: "${raw}". Keys: name (string), cals (number), prot (number), carb (number), fat (number). Example: {"name":"Chicken Breast 200g","cals":330,"prot":62,"carb":0,"fat":7}` }] }]
                        })
                    });
                    const data = await res.json();
                    const text = data.candidates[0].content.parts[0].text.trim().replace(/```json|```/g, '');
                    const json = JSON.parse(text);
                    setInput({ name: json.name, cals: json.cals, prot: json.prot, carb: json.carb, fat: json.fat });
                } catch (e) {
                    console.error(e);
                    showFeedback('AI failed – check key', 'error');
                }
                setLoading(false);
            };

            const add = () => {
                if (!input.name) return;
                setLogs([{
                    id: Date.now(),
                    date: today,
                    time: Date.now(),
                    ...input,
                    cals: Number(input.cals) || 0,
                    prot: Number(input.prot) || 0,
                    carb: Number(input.carb) || 0,
                    fat: Number(input.fat) || 0
                }, ...logs]);
                setInput({ name: '', cals: '', prot: '', carb: '', fat: '' });
                setRaw('');
                showFeedback('Added!', 'success');
            };

            return (
                <div className="space-y-6 pb-20">
                    <ActivityRings cals={totals.cals} calsT={GOALS.calories} prot={totals.p} protT={GOALS.protein} carbs={totals.c} carbsT={GOALS.carbs} />

                    <div className="bg-slate-900 p-5 rounded-2xl border border-slate-800 shadow-lg">
                        <div className="flex gap-3 mb-4">
                            <input className="flex-1 bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white focus:border-emerald-500 transition" placeholder="e.g. 2 eggs + avocado toast"
                                value={raw} onChange={e => setRaw(e.target.value)} onKeyDown={e => e.key === 'Enter' && callGemini()} />
                            <button onClick={callGemini} disabled={loading} className="bg-emerald-600 px-6 rounded-xl font-bold text-white disabled:opacity-50">
                                {loading ? '...' : 'AI'}
                            </button>
                        </div>

                        {(input.name || input.cals) && (
                            <div className="space-y-4">
                                <input className="w-full bg-transparent border-b border-slate-700 text-xl font-bold outline-none" value={input.name}
                                    onChange={e => setInput({ ...input, name: e.target.value })} />
                                <div className="grid grid-cols-4 gap-3">
                                    {['cals', 'prot', 'carb', 'fat'].map(k => (
                                        <div key={k} className="bg-slate-950/50 rounded-lg p-3 text-center border border-slate-800">
                                            <div className="text-xs text-slate-500 uppercase font-bold">{k}</div>
                                            <input type="number" className="w-full bg-transparent text-xl font-bold text-white outline-none"
                                                value={input[k]} onChange={e => setInput({ ...input, [k]: e.target.value })} />
                                        </div>
                                    ))}
                                </div>
                                <button onClick={add} className="w-full bg-emerald-600 py-4 rounded-xl font-bold text-white shadow-lg">Add Entry</button>
                            </div>
                        )}
                    </div>

                    {['Breakfast', 'Lunch', 'Dinner', 'Snacks'].map(meal => {
                        const items = logs.filter(l => l.date === today && getMeal(new Date(l.time).getHours()) === meal);
                        if (!items.length) return null;
                        return (
                            <div key={meal}>
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 ml-2 mb-2">{meal}</h3>
                                <div className="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden">
                                    {items.map((l, i) => (
                                        <div key={l.id} className={`flex justify-between items-center p-4 ${i < items.length - 1 ? 'border-b border-slate-800' : ''}`}>
                                            <div>
                                                <div className="font-bold">{l.name}</div>
                                                <div className="text-xs text-slate-500">{l.prot}p • {l.carb}c • {l.fat}f</div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-emerald-400 text-lg">{l.cals}</span>
                                                <button onClick={() => setLogs(logs.filter(x => x.id !== l.id))} className="text-red-500">
                                                    <Icon name="Trash" size={20} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [tab, setTab] = useState('gym');
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [fb, setFb] = useState({ msg: '', type: '' });

            const showFeedback = (msg, type = 'success') => {
                setFb({ msg, type });
                setTimeout(() => setFb({ msg: '', type: '' }), 3000);
            };

            useEffect(() => {
                const loader = document.getElementById('loader');
                const root = document.getElementById('root');
                setTimeout(() => {
                    loader.style.opacity = '0';
                    root.style.opacity = '1';
                    setTimeout(() => loader.remove(), 600);
                }, 300);
            }, []);

            return (
                <div className="max-w-md mx-auto p-5">
                    {fb.msg && (
                        <div className={`fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full z-50 font-bold shadow-2xl backdrop-blur-md text-white ${fb.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>
                            {fb.msg}
                        </div>
                    )}

                    <div className="flex justify-between items-end mb-8">
                        <h1 className="text-4xl font-black italic">{tab === 'gym' ? 'WORKOUT' : 'NUTRITION'}</h1>
                        <button onClick={() => setSettingsOpen(true)} className="p-3 bg-slate-800 rounded-full">
                            <Icon name="Settings" size={24} className="text-slate-400" />
                        </button>
                    </div>

                    {settingsOpen && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-5" onClick={() => setSettingsOpen(false)}>
                            <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Gemini API Key</h3>
                                <input type="password" className="w-full bg-slate-950 px-4 py-3 rounded-xl border border-slate-700 mb-4"
                                    placeholder="Paste your key here" defaultValue={apiKey}
                                    onChange={e => apiKey = e.target.value.trim()} />
                                <button onClick={() => { SAFE_SAVE('hos_api_key', apiKey); setSettingsOpen(false); showFeedback('Key saved'); }}
                                    className="w-full bg-cyan-600 py-4 rounded-xl font-bold text-white">Save & Close</button>
                                <div className="text-center mt-4">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-cyan-400 underline">Get free key →</a>
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'gym' ? <GymTracker showFeedback={showFeedback} /> : <FoodTracker showFeedback={showFeedback} />}

                    <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-xl border border-slate-800 rounded-full shadow-2xl flex z-40">
                        <button onClick={() => setTab('gym')} className={`px-10 py-4 rounded-full font-bold transition-all ${tab === 'gym' ? 'bg-cyan-500 text-white shadow-lg' : 'text-slate-400'}`}>GYM</button>
                        <button onClick={() => setTab('food')} className={`px-10 py-4 rounded-full font-bold transition-all ${tab === 'food' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400'}`}>FOOD</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
