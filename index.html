import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import {
  getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, where
} from 'firebase/firestore';

// --- FIREBASE SETUP ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const apiKey = ""; // Injected at runtime

// --- USER GOALS (6'2", 87kg, Recomp) ---
const GOALS = {
  calories: 2350,
  protein: 180
};

// --- GYM DATA ---
const INITIAL_GYM_DAYS = [
  { day: 'Day 1', name: 'Push (Chest/Shoulders/Tri)', exercises: [
    'Bench Press', 'Incline DB Press', 'Overhead Press', 'Lateral Raises', 'Triceps Extension'
  ]},
  { day: 'Day 3', name: 'Legs & Core', exercises: [
    'Squats', 'RDLs', 'Leg Extensions', 'Hamstring Curls', 'Calf Raises', 'Cable Crunches'
  ]},
  { day: 'Day 5', name: 'Pull (Back/Biceps)', exercises: [
    'Barbell Rows', 'Lat Pulldowns', 'Face Pulls', 'Bicep Curls', 'Hammer Curls'
  ]},
];

// --- COMPONENT: PROGRESS BAR ---
const ProgressBar = ({ current, target, colorClass, label }) => {
  const percentage = Math.min(100, Math.max(0, (current / target) * 100));
  const left = target - current;
  
  return (
    <div className="w-full mb-3">
      <div className="flex justify-between text-xs font-bold uppercase mb-1 tracking-wider">
        <span className={colorClass}>{label}</span>
        <span className="text-white">
          {current} / {target} <span className="text-slate-500 ml-1">({left > 0 ? `${left} left` : `${Math.abs(left)} over`})</span>
        </span>
      </div>
      <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
        <div 
          className={`h-full transition-all duration-500 ease-out ${percentage >= 100 ? 'bg-red-500' : colorClass.replace('text-', 'bg-')}`} 
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
};

// --- COMPONENT: GYM TRACKER ---
const GymTracker = ({ db, userId, showFeedback }) => {
  const [gymWorkouts, setGymWorkouts] = useState(INITIAL_GYM_DAYS);
  const [currentDayIndex, setCurrentDayIndex] = useState(0);
  const [inputData, setInputData] = useState({});
  const [newExerciseName, setNewExerciseName] = useState('');
  const [view, setView] = useState('active');
  const [historyLogs, setHistoryLogs] = useState([]);
  const [activeTip, setActiveTip] = useState(null);
  const [tipLoading, setTipLoading] = useState(false);

  const currentGymDay = gymWorkouts[currentDayIndex];

  useEffect(() => {
    if (!db || !userId) return;
    const q = query(collection(db, 'artifacts', appId, 'users', userId, 'workout_logs'));
    const unsub = onSnapshot(q, (snap) => {
      const logs = snap.docs.map(d => ({ id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate().toLocaleString() }));
      logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      setHistoryLogs(logs);
    });
    return () => unsub();
  }, [db, userId]);

  const handleInputChange = (exName, setIndex, field, val) => {
    setInputData(prev => ({
      ...prev, [exName]: { ...prev[exName], [setIndex]: { ...prev[exName]?.[setIndex], [field]: val } }
    }));
  };

  const handleSubmit = async () => {
    const today = new Date().toISOString().split('T')[0];
    const logId = `${today}-${currentGymDay.day}`;
    const exercises = Object.entries(inputData).reduce((acc, [name, setsData]) => {
      const sets = Object.entries(setsData).map(([idx, d]) => ({
        set: parseInt(idx) + 1, weight: parseFloat(d.weight) || 0, reps: parseInt(d.reps) || 0
      })).filter(s => s.weight > 0 || s.reps > 0);
      if (sets.length) acc.push({ exerciseName: name, sets });
      return acc;
    }, []);

    if (!exercises.length) return showFeedback('Enter at least one set', 'error');

    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'workout_logs', logId), {
        userId, day: currentGymDay.day, dayName: currentGymDay.name, date: today, timestamp: serverTimestamp(), exercises
      });
      showFeedback('Workout Logged!', 'success');
      setInputData({});
    } catch (e) { showFeedback('Save failed', 'error'); }
  };

  const handleAddExercise = () => {
    if (!newExerciseName.trim()) return;
    const updated = [...gymWorkouts];
    updated[currentDayIndex].exercises.push(newExerciseName.trim());
    setGymWorkouts(updated);
    setNewExerciseName('');
  };

  const handleRemoveExercise = (name) => {
    const updated = [...gymWorkouts];
    updated[currentDayIndex].exercises = updated[currentDayIndex].exercises.filter(e => e !== name);
    setGymWorkouts(updated);
  };

  const getFormTips = async (exerciseName) => {
    setTipLoading(exerciseName);
    setActiveTip(null);
    try {
      const prompt = `Provide 3 short, expert form cues for the gym exercise "${exerciseName}". Also mention 1 common mistake to avoid. Keep it very concise.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      setActiveTip({ name: exerciseName, text: data.candidates?.[0]?.content?.parts?.[0]?.text });
    } catch (e) { showFeedback('Could not load tips', 'error'); } finally { setTipLoading(false); }
  };

  if (view === 'history') {
    return (
      <div className="space-y-4 pb-20">
        <button onClick={() => setView('active')} className="text-cyan-400 font-bold mb-4">&larr; Back to Logger</button>
        {historyLogs.map(log => (
          <div key={log.id} className="bg-slate-800 p-4 rounded-xl border-l-4 border-cyan-500">
            <div className="flex justify-between mb-2"><h3 className="font-bold">{log.dayName}</h3><span className="text-xs text-slate-400">{log.date}</span></div>
            {log.exercises.map((e, i) => (
              <div key={i} className="text-sm text-slate-300 mb-1">
                <span className="text-cyan-200">{e.exerciseName}:</span> {e.sets.map(s => `${s.weight}x${s.reps}`).join(', ')}
              </div>
            ))}
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="pb-24 space-y-6 relative">
      {activeTip && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setActiveTip(null)}>
          <div className="bg-slate-800 p-6 rounded-2xl max-w-sm w-full border border-cyan-500 shadow-2xl relative animate-in zoom-in-95" onClick={e => e.stopPropagation()}>
            <button onClick={() => setActiveTip(null)} className="absolute top-3 right-3 text-slate-400 hover:text-white">✕</button>
            <h3 className="text-xl font-bold text-cyan-400 mb-4">✨ {activeTip.name} Coach</h3>
            <div className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">{activeTip.text}</div>
          </div>
        </div>
      )}

      <div className="bg-slate-800 p-4 rounded-xl shadow-lg flex flex-col items-center relative">
        <button onClick={() => setView('history')} className="absolute top-2 right-2 text-xs text-cyan-400 border border-cyan-400 px-2 py-1 rounded">History</button>
        <div className="flex items-center justify-between w-full mt-4">
          <button onClick={() => setCurrentDayIndex((i) => (i - 1 + gymWorkouts.length) % gymWorkouts.length)} className="p-2 text-cyan-400 text-2xl">‹</button>
          <div className="text-center">
            <input value={currentGymDay.name} onChange={(e) => {const u = [...gymWorkouts]; u[currentDayIndex].name = e.target.value; setGymWorkouts(u);}} 
              className="bg-transparent text-xl font-bold text-center w-48 focus:border-b border-cyan-500 outline-none" />
            <div className="text-xs text-slate-400 uppercase tracking-wider">{currentGymDay.day}</div>
          </div>
          <button onClick={() => setCurrentDayIndex((i) => (i + 1) % gymWorkouts.length)} className="p-2 text-cyan-400 text-2xl">›</button>
        </div>
      </div>

      <div className="space-y-4">
        {currentGymDay.exercises.map(ex => (
          <div key={ex} className="bg-slate-800 p-3 rounded-xl shadow">
            <div className="flex justify-between mb-2 items-center">
              <div className="flex items-center gap-2">
                <span className="font-semibold text-cyan-100">{ex}</span>
                <button onClick={() => getFormTips(ex)} className="text-xs bg-slate-700 text-cyan-400 px-2 py-0.5 rounded-full border border-cyan-500/30" disabled={tipLoading === ex}>
                  {tipLoading === ex ? '...' : '✨ Tips'}
                </button>
              </div>
              <button onClick={() => handleRemoveExercise(ex)} className="text-red-400 text-xs px-2">×</button>
            </div>
            <div className="flex gap-2 overflow-x-auto">
              {[0,1,2].map(i => (
                <div key={i} className="flex-shrink-0 w-28 bg-slate-700 rounded p-2 flex gap-1">
                  <input type="number" step="0.5" placeholder="kg" className="w-1/2 bg-slate-600 rounded px-1 text-center text-sm" 
                    onChange={(e) => handleInputChange(ex, i, 'weight', e.target.value)} value={inputData[ex]?.[i]?.weight || ''} />
                  <input type="number" placeholder="reps" className="w-1/2 bg-slate-600 rounded px-1 text-center text-sm" 
                    onChange={(e) => handleInputChange(ex, i, 'reps', e.target.value)} value={inputData[ex]?.[i]?.reps || ''} />
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div className="flex gap-2">
        <input className="bg-slate-800 flex-1 p-3 rounded-xl outline-none" placeholder="Add new exercise..." 
          value={newExerciseName} onChange={e => setNewExerciseName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddExercise()} />
        <button onClick={handleAddExercise} className="bg-slate-700 px-4 rounded-xl font-bold text-cyan-400">+</button>
      </div>

      <button onClick={handleSubmit} className="w-full bg-cyan-500 hover:bg-cyan-400 text-slate-900 py-4 rounded-xl font-bold text-lg shadow-lg shadow-cyan-500/20 transition-all">LOG WORKOUT</button>
    </div>
  );
};

// --- COMPONENT: FOOD TRACKER ---
const FoodTracker = ({ db, userId, showFeedback }) => {
  const [logs, setLogs] = useState([]);
  const [aiLoading, setAiLoading] = useState(false);
  const [foodInput, setFoodInput] = useState('');
  const [suggestLoading, setSuggestLoading] = useState(false);
  const [suggestion, setSuggestion] = useState('');
  const [staging, setStaging] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '' });

  const todayStr = new Date().toISOString().split('T')[0];

  useEffect(() => {
    if (!db || !userId) return;
    const q = query(collection(db, 'artifacts', appId, 'users', userId, 'food_logs'), where('date', '==', todayStr));
    const unsub = onSnapshot(q, (snap) => setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    return () => unsub();
  }, [db, userId, todayStr]);

  const totals = logs.reduce((acc, item) => ({
    cals: acc.cals + (item.calories || 0),
    p: acc.p + (item.protein || 0),
    c: acc.c + (item.carbs || 0),
    f: acc.f + (item.fat || 0),
  }), { cals: 0, p: 0, c: 0, f: 0 });

  const handleAiEstimate = async () => {
    if (!foodInput.trim()) return;
    setAiLoading(true);
    try {
      const prompt = `Estimate nutrition for: "${foodInput}". Return JSON only: { "name": "short name", "calories": number, "protein": number, "carbs": number, "fat": number }. If unknown, guess.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      const result = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json|```/g, '').trim());
      setStaging({ name: result.name || foodInput, calories: result.calories || 0, protein: result.protein || 0, carbs: result.carbs || 0, fat: result.fat || 0 });
      showFeedback('Est. Complete', 'success');
    } catch (e) { showFeedback('AI failed', 'error'); setStaging({ name: foodInput, calories: '', protein: '', carbs: '', fat: '' }); } finally { setAiLoading(false); }
  };

  const handleSuggestMeal = async () => {
    setSuggestLoading(true);
    setSuggestion('');
    try {
      const eatenList = logs.map(l => l.name).join(', ') || 'Nothing yet';
      const prompt = `My daily goals are ${GOALS.calories} calories and ${GOALS.protein}g protein. Today I have eaten: ${eatenList} (Total: ${totals.cals} cal, ${totals.p}g prot). Suggest ONE meal to eat next to help me hit these targets precisely. Keep it under 20 words.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      setSuggestion(await response.json().then(d => d.candidates?.[0]?.content?.parts?.[0]?.text));
    } catch (e) { showFeedback('Chef busy', 'error'); } finally { setSuggestLoading(false); }
  };

  const handleAddFood = async () => {
    if (!staging.name || !staging.calories) return showFeedback('Name/Cals required', 'error');
    try {
      await setDoc(doc(collection(db, 'artifacts', appId, 'users', userId, 'food_logs')), {
        userId, date: todayStr, timestamp: serverTimestamp(),
        name: staging.name, calories: parseInt(staging.calories), protein: parseInt(staging.protein) || 0, carbs: parseInt(staging.carbs) || 0, fat: parseInt(staging.fat) || 0
      });
      setStaging({ name: '', calories: '', protein: '', carbs: '', fat: '' }); setFoodInput(''); showFeedback('Logged', 'success');
    } catch (e) { showFeedback('Error', 'error'); }
  };

  return (
    <div className="pb-24 space-y-6">
      <div className="bg-emerald-900/40 border border-emerald-500/30 p-5 rounded-2xl shadow-lg">
        <h3 className="text-emerald-400 text-sm font-bold uppercase mb-4">Daily Targets</h3>
        
        <ProgressBar current={totals.cals} target={GOALS.calories} colorClass="text-emerald-400" label="Calories" />
        <ProgressBar current={totals.p} target={GOALS.protein} colorClass="text-blue-400" label="Protein (g)" />
        
        <div className="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-emerald-500/20">
           <div className="text-xs text-emerald-200/70">Carbs: <span className="text-white text-sm font-bold">{totals.c}g</span></div>
           <div className="text-xs text-emerald-200/70">Fat: <span className="text-white text-sm font-bold">{totals.f}g</span></div>
        </div>

        {!suggestion ? (
          <button onClick={handleSuggestMeal} disabled={suggestLoading} className="mt-4 w-full bg-emerald-800/50 border border-emerald-500/30 text-emerald-200 py-2 rounded-lg text-sm font-bold">
            {suggestLoading ? 'Thinking...' : '✨ What should I eat next?'}
          </button>
        ) : (
          <div className="mt-4 bg-emerald-950/50 p-3 rounded-lg border border-emerald-500/40">
            <div className="flex justify-between items-start">
               <p className="text-sm text-emerald-100 italic pr-2">"{suggestion}"</p>
               <button onClick={() => setSuggestion('')} className="text-emerald-500 hover:text-white">✕</button>
            </div>
          </div>
        )}
      </div>

      <div className="bg-slate-800 p-4 rounded-xl shadow-lg space-y-4">
        <div className="flex gap-2">
          <input className="flex-1 bg-slate-700 text-white p-3 rounded-xl outline-none" placeholder="e.g., 200g Chicken Breast" 
            value={foodInput} onChange={e => setFoodInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAiEstimate()} />
          <button onClick={handleAiEstimate} disabled={aiLoading} className="bg-emerald-600 text-white px-4 rounded-xl font-bold disabled:opacity-50">{aiLoading ? '...' : '✨ Auto'}</button>
        </div>
        {(staging.name || staging.calories || foodInput) && (
          <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-3 animate-in fade-in slide-in-from-top-2">
            <input className="w-full bg-transparent border-b border-slate-600 text-white outline-none" value={staging.name} onChange={e => setStaging({...staging, name: e.target.value})} placeholder="Food Name" />
            <div className="grid grid-cols-4 gap-2">
              {['calories', 'protein', 'carbs', 'fat'].map(k => (
                 <div key={k} className="flex flex-col"><span className="text-[10px] text-slate-500 uppercase">{k.substring(0,4)}</span>
                 <input type="number" className="bg-slate-700 rounded p-1 text-center text-sm" value={staging[k]} onChange={e => setStaging({...staging, [k]: e.target.value})} /></div>
              ))}
            </div>
            <button onClick={handleAddFood} className="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold text-sm">Add to Log</button>
          </div>
        )}
      </div>

      <div className="space-y-2">
        {logs.length === 0 && <div className="text-slate-500 text-center text-sm py-4">No food logged yet.</div>}
        {logs.map(item => (
          <div key={item.id} className="bg-slate-800 p-3 rounded-xl flex justify-between items-center group">
            <div><div className="font-medium text-white">{item.name}</div><div className="text-xs text-slate-400">{item.protein}p • {item.carbs}c • {item.fat}f</div></div>
            <div className="flex items-center gap-3"><span className="font-bold text-emerald-400">{item.calories}</span><button onClick={async () => await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'food_logs', item.id))} className="text-slate-600 hover:text-red-400 p-1">×</button></div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default function HealthApp() {
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);
  const [activeTab, setActiveTab] = useState('gym');
  const [feedback, setFeedback] = useState({ msg: '', type: '' });
  const showFeedback = (msg, type) => { setFeedback({ msg, type }); setTimeout(() => setFeedback({ msg: '', type: '' }), 3000); };

  useEffect(() => {
    const init = async () => {
      const app = initializeApp(firebaseConfig);
      setDb(getFirestore(app));
      const auth = getAuth(app);
      onAuthStateChanged(auth, u => u ? setUserId(u.uid) : initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
    };
    init();
  }, []);

  return (
    <div className="min-h-screen bg-slate-900 text-white font-sans selection:bg-cyan-500/30">
      {feedback.msg && <div className={`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-xl z-50 font-medium ${feedback.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>{feedback.msg}</div>}
      <div className="max-w-md mx-auto p-4 min-h-screen flex flex-col">
        <div className="flex-1 mt-2">
          {!userId ? <div className="text-center text-slate-500 mt-20 animate-pulse">Loading Health OS...</div> : activeTab === 'gym' ? <GymTracker db={db} userId={userId} showFeedback={showFeedback} /> : <FoodTracker db={db} userId={userId} showFeedback={showFeedback} />}
        </div>
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-md border border-slate-700 p-1.5 rounded-full shadow-2xl flex gap-1 z-40">
          <button onClick={() => setActiveTab('gym')} className={`px-6 py-2.5 rounded-full font-bold text-sm transition-all ${activeTab === 'gym' ? 'bg-cyan-500 text-slate-900 shadow-lg shadow-cyan-500/25' : 'text-slate-400 hover:text-white'}`}>GYM</button>
          <button onClick={() => setActiveTab('food')} className={`px-6 py-2.5 rounded-full font-bold text-sm transition-all ${activeTab === 'food' ? 'bg-emerald-500 text-slate-900 shadow-lg shadow-emerald-500/25' : 'text-slate-400 hover:text-white'}`}>FOOD</button>
        </div>
      </div>
    </div>
  );
}
