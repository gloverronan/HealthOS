<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">
  <title>Health OS</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } } }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- FIREBASE JS SDKS (COMPATIBILITY VERSION) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <style>
    body { background: #020617; color: white; overscroll-behavior: none; }
    #loader { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.7s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="min-h-screen">

<div id="loader">
  <div class="text-center">
    <div class="w-16 h-16 border-4 border-slate-800 border-t-cyan-500 rounded-full animate-spin mb-6"></div>
    <div class="text-3xl font-black tracking-tighter">Health OS</div>
    <div class="text-sm text-slate-500 mt-2 tracking-widest" id="loader-status">CONNECTING</div>
  </div>
</div>

<div id="root" class="opacity-0 transition-opacity duration-700"></div>

<script type="text/babel">
  const { useState, useEffect, useMemo } = React;

  // --- LOCAL STORAGE HELPERS (FOR KEYS AND CONFIG) ---
  const loadItem = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) || def; } catch { return def; } };
  const saveItem = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
  const loadKey = (k) => { try { return localStorage.getItem(k) || ''; } catch { return ''; } };
  const saveKey = (k, v) => { try { localStorage.setItem(k, v); } catch {} };

  const GOALS = { calories: 2350, protein: 180, carbs: 250 };
  let GEMINI_KEY = loadKey('hos_gemini_key'); 

  const DEFAULT_WORKOUTS = [
    { id: "push", name: "Push", color: "#ec4899", exercises: ["Bench Press", "Overhead Press", "Tricep Extensions"] },
    { id: "legs", name: "Legs", color: "#3b82f6", exercises: ["Squat", "Romanian Deadlift", "Calf Raises"] },
    { id: "pull", name: "Pull", color: "#10b981", exercises: ["Pull-ups", "Barbell Row", "Bicep Curls"] }
  ];
  
  // --- FIREBASE GLOBALS ---
  let DB = null;
  let AUTH = null;
  let USER_ID = null;

  // --- AUTH COMPONENTS ---
  const AuthModal = ({ showToast, onAuthSuccess }) => {
    const [mode, setMode] = useState('login'); // 'login' or 'signup'
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async () => {
      if (!email || !password) return setError('Email and password required.');
      setIsLoading(true);
      setError('');
      
      try {
        if (mode === 'signup') {
          await AUTH.createUserWithEmailAndPassword(email, password);
          showToast('Account created! Logging in...', 'success');
        } else {
          await AUTH.signInWithEmailAndPassword(email, password);
          showToast('Logged in successfully!', 'success');
        }
        onAuthSuccess();

      } catch (e) {
        let msg = "Authentication failed. Check credentials.";
        if (e.code) {
          msg = e.message.replace('Firebase:', '').trim();
        }
        setError(msg);
      } finally {
        setIsLoading(false);
      }
    };
    
    const handleGoogleSignIn = async () => {
        setIsLoading(true);
        setError('');
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await AUTH.signInWithPopup(provider);
            showToast('Signed in with Google!', 'success');
            onAuthSuccess();
        } catch (e) {
            if (e.code !== 'auth/popup-closed-by-user') {
                setError('Google sign-in failed. Try email/password or check Firebase setup.');
            }
        } finally {
            setIsLoading(false);
        }
    };

    return (
      <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md">
        <div className="bg-slate-900/90 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl">
          <h3 className="text-3xl font-black mb-6 text-center">{mode === 'login' ? 'Log In' : 'Create Account'}</h3>
          
          {error && <div className="bg-red-600/20 text-red-400 p-3 rounded-lg mb-4 text-sm">{error}</div>}

          <button onClick={handleGoogleSignIn} disabled={isLoading}
                  className="w-full py-4 rounded-xl font-bold mb-3 bg-slate-800 text-white hover:bg-slate-700 transition-colors disabled:opacity-50">
            {isLoading ? '...' : 'Sign in with Google'}
          </button>
          
          <div className="text-center text-xs text-slate-600 mb-3 uppercase tracking-widest">or</div>

          <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} 
                 className="w-full bg-slate-800 p-4 rounded-xl mb-3 border border-slate-700 outline-none" />
          <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} 
                 className="w-full bg-slate-800 p-4 rounded-xl mb-6 border border-slate-700 outline-none" />
          
          <button onClick={handleSubmit} disabled={isLoading}
                  className={`w-full py-4 rounded-xl font-bold text-lg ${mode === 'login' ? 'bg-cyan-600 hover:bg-cyan-500' : 'bg-emerald-600 hover:bg-emerald-500'} disabled:opacity-50 transition-colors`}>
            {isLoading ? 'Processing...' : mode === 'login' ? 'Log In' : 'Create Account'}
          </button>

          <button onClick={() => setMode(mode === 'login' ? 'signup' : 'login')}
                  className="w-full mt-4 text-slate-400 text-sm hover:text-white transition-colors">
            {mode === 'login' ? "Don't have an account? Sign Up" : "Already have an account? Log In"}
          </button>
        </div>
      </div>
    );
  };


  // --- SETTINGS MODAL ---
  const SettingsModal = ({ isVisible, onClose, onSave, currentKey, currentDbConfig }) => {
    const [keyInput, setKeyInput] = useState(currentKey);
    const [dbConfig, setDbConfig] = useState(currentDbConfig);
    const [isChecking, setIsChecking] = useState(false);

    if (!isVisible) return null;

    const checkKey = async (key) => {
        if (!key.trim()) return true;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: "test" }] }] })
            });
            return res.ok;
        } catch { return false; }
    };

    const checkDbValidity = async (config) => {
        if (!config.projectId) return true;
        let tempApp = null;
        try {
            const tempAppName = 'temp_check_' + Date.now();
            tempApp = firebase.initializeApp(config, tempAppName);
            const tempDb = tempApp.firestore();
            await tempDb.collection('metadata').doc('test').get();
            return true;
        } catch (e) {
            return false;
        } finally {
            if (tempApp) tempApp.delete();
        }
    };

    const handleSave = async () => {
        setIsChecking(true);
        
        let keyStatus = await checkKey(keyInput);
        let dbStatus = await checkDbValidity(dbConfig);
        
        setIsChecking(false);

        if (keyStatus && dbStatus) {
            onSave(keyInput, dbConfig, 'Settings saved and verified!', 'success');
        } else {
            onSave(keyInput, dbConfig, 'Validation failed: ' + (!keyStatus ? 'Gemini Key Invalid. ' : '') + (!dbStatus ? 'Database Config Invalid.' : ''), 'error');
        }
    };

    const updateConfig = (field, value) => setDbConfig(prev => ({...prev, [field]: value}));

    return (
      <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
        <div className="bg-slate-900/90 border border-slate-700 p-6 rounded-xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh]" onClick={e => e.stopPropagation()}>
          <h3 className="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Application Settings</h3>
          
          <p className="text-sm text-cyan-400 mb-4 font-bold">Persistence (Firestore Config)</p>
          <div className="space-y-3 mb-6">
            {['apiKey', 'authDomain', 'projectId', 'appId'].map(field => (
                <input key={field} type="text" className="w-full bg-slate-950 text-white p-3 rounded-xl border border-slate-700 outline-none focus:border-cyan-500 text-sm" placeholder={`Firebase Config: ${field}`} value={dbConfig[field] || ''} onChange={e => updateConfig(field, e.target.value)} />
            ))}
            <p className="text-xs text-slate-500 pt-2">Input your 4 core config parameters here to enable persistent cloud storage.</p>
          </div>
          
          <p className="text-sm text-emerald-400 mb-4 font-bold border-t border-slate-700 pt-4">AI Calorie Estimation (Gemini)</p>
          <input type="password" className="w-full bg-slate-950 text-white p-3 rounded-xl border border-slate-700 mb-4 outline-none focus:border-emerald-500" placeholder="Gemini API Key" value={keyInput} onChange={e => setKeyInput(e.target.value)} disabled={isChecking} />
          
          <button onClick={handleSave} disabled={isChecking} className="w-full bg-cyan-600 py-3 rounded-xl font-bold text-lg hover:bg-cyan-500 transition-colors disabled:opacity-50 mt-4">
            {isChecking ? 'Verifying...' : 'Verify & Save All Settings'}
          </button>
          <div className="text-center mt-4">
            <button onClick={onClose} className="text-slate-500 hover:text-white text-sm">Close</button>
          </div>
        </div>
      </div>
    );
  };

  // --- MAIN APP COMPONENT ---
  const App = () => {
    const [tab, setTab] = useState('summary');
    const [foodLog, setFoodLog] = useState([]);
    const [gymLog, setGymLog] = useState([]);
    const [cardioLog, setCardioLog] = useState([]);
    const [workouts, setWorkouts] = useState(loadItem('hos_workouts', DEFAULT_WORKOUTS));
    const [toast, setToast] = useState(null);
    const [showSettings, setShowSettings] = useState(false);
    
    // Persistence States
    const [dbConfig, setDbConfig] = useState(loadItem('hos_db_config', {}));
    const [isDbInitialized, setIsDbInitialized] = useState(false);
    const [userId, setUserId] = useState(null);
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [showAuth, setShowAuth] = useState(false);
    const [connectionFailed, setConnectionFailed] = useState(false); 

    const isReady = isDbInitialized && userId;
    const today = new Date().toISOString().split('T')[0];

    const showToast = (msg, type = 'success') => {
      setToast({ msg, type });
      setTimeout(() => setToast(null), 3000);
    };

    // --- FIREBASE INITIALIZATION ---
    useEffect(() => {
        if (!dbConfig.projectId || typeof firebase === 'undefined') {
            document.getElementById('loader-status').innerText = 'SETUP REQUIRED';
            return;
        }
        
        let initialized = false; 

        const initializeDb = () => {
             if (initialized) return;
             initialized = true;

             try {
                const existingApp = firebase.apps.find(app => app.name === dbConfig.projectId);
                if (existingApp) { existingApp.delete(); }

                const app = firebase.initializeApp(dbConfig, dbConfig.projectId);
                DB = app.firestore();
                AUTH = app.auth();
                DB.settings({ timestampsInSnapshots: true });

                AUTH.onAuthStateChanged(user => {
                    if (user) {
                        // User logged in or signed in anonymously
                        USER_ID = user.uid;
                        setUserId(USER_ID);
                        setIsLoggedIn(user.isAnonymous === false);
                        setIsDbInitialized(true);
                        setConnectionFailed(false);
                        document.getElementById('loader-status').innerText = user.isAnonymous ? 'ANONYMOUS' : 'LOGGED IN';
                        setShowAuth(false);
                    } else if (dbConfig.projectId) {
                        // Attempt Anonymous Sign-in if no user is found
                        AUTH.signInAnonymously().catch(e => {
                            console.error("Auth Failed:", e);
                            document.getElementById('loader-status').innerText = 'AUTH FAILED';
                            setConnectionFailed(true);
                        });
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('loader-status').innerText = 'CONFIG ERROR';
                setConnectionFailed(true);
            }
        };

        initializeDb();
    }, [dbConfig]);

    // --- FIREBASE DATA LISTENERS ---
    useEffect(() => {
        if (!isReady) return;

        const logRef = DB.collection(`users/${userId}/`);
        
        const unsubFood = logRef.doc('food_logs').collection('logs').onSnapshot(snapshot => {
            setFoodLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || b.id) - (a.timestamp?.seconds || a.id)));
        }, (error) => {
            console.error("Firestore Food Listener Failed:", error);
            showToast('Data sync failed. Check Security Rules.', 'error');
        });
        const unsubGym = logRef.doc('gym_logs').collection('logs').onSnapshot(snapshot => {
            setGymLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || b.id) - (a.timestamp?.seconds || a.id)));
        });
        const unsubCardio = logRef.doc('cardio_logs').collection('logs').onSnapshot(snapshot => {
            setCardioLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || b.id) - (a.timestamp?.seconds || a.id)));
        });

        return () => { unsubFood(); unsubGym(); unsubCardio(); };
    }, [isReady, userId]);

    // --- LOGIC AND DATA ---
    useEffect(() => { saveItem('hos_workouts', workouts); }, [workouts]);
    useEffect(() => { saveItem('hos_db_config', dbConfig); }, [dbConfig]);

    // --- LOADER HIDE LOGIC (FAILSAFE) ---
    useEffect(() => {
      let loaderTimer;
      
      const hideLoader = (statusText) => {
        const loader = document.getElementById('loader');
        const root = document.getElementById('root');
        if (loader && root) {
            document.getElementById('loader-status').innerText = statusText;
            loader.style.opacity = '0';
            root.style.opacity = '1';
            setTimeout(() => loader.remove(), 700);
        }
      };

      if (isReady || connectionFailed || !dbConfig.projectId) {
          clearTimeout(loaderTimer);
          hideLoader(isReady ? 'READY' : connectionFailed ? 'ERROR' : 'SETUP REQUIRED');
      } else {
          loaderTimer = setTimeout(() => {
              setConnectionFailed(true);
          }, 5000);
      }
      
      return () => clearTimeout(loaderTimer);
      
    }, [isReady, dbConfig, connectionFailed]);


    const todaysData = useMemo(() => {
      const food = foodLog.filter(f => f.date === today);
      const gym = gymLog.filter(g => g.date === today);
      const cardio = cardioLog.filter(c => c.date === today);

      const totals = food.reduce((a, b) => ({
        cals: a.cals + (b.cals || 0),
        prot: a.prot + (b.prot || 0),
        carb: a.carb + (b.carb || 0)
      }), { cals: 0, prot: 0, carb: 0 });

      return { food, gym, cardio, totals };
    }, [foodLog, gymLog, cardioLog, today]);

    const handleSettingsSave = (gemini, dbCfg, msg, type) => {
        GEMINI_KEY = gemini;
        saveKey('hos_gemini_key', GEMINI_KEY);
        setDbConfig(dbCfg);
        setShowSettings(false);
        showToast(msg, type);
    };
    
    const handleLogout = async () => {
        await AUTH.signOut();
        showToast('Logged out.', 'success');
    };

    return (
      <div className="max-w-md mx-auto min-h-screen pb-32 px-6 pt-8">
        {toast && (
          <div className={`fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full z-50 font-bold shadow-2xl ${toast.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>
            {toast.msg}
          </div>
        )}

        {/* CONNECTION BANNER */}
        {connectionFailed && (
             <div className="bg-red-900/50 border border-red-500/50 p-3 rounded-xl mb-6 text-center text-sm text-red-300 font-bold">
                 DATABASE CONNECTION FAILED. Please check settings (gear icon).
             </div>
        )}

        {/* AUTH CHECK: Show login/signup if not permanently logged in */}
        {isReady && !isLoggedIn && (
            <div className="fixed inset-0 bg-black/80 z-40 flex items-center justify-center">
                <AuthModal showToast={showToast} onAuthSuccess={() => setShowAuth(false)} />
            </div>
        )}
        
        {/* SETTINGS MODAL */}
        <SettingsModal isVisible={showSettings} onClose={() => setShowSettings(false)} onSave={handleSettingsSave} currentKey={GEMINI_KEY} currentDbConfig={dbConfig} />

        <div className="flex justify-between items-center mb-8">
          <h1 className="text-5xl font-black">{tab === 'food' ? 'FOOD' : tab === 'gym' ? 'GYM' : tab === 'cardio' ? 'CARDIO' : 'SUMMARY'}</h1>
          
          <div className="flex items-center space-x-3">
            {isLoggedIn && (
                <button onClick={handleLogout} className="p-2 bg-slate-800 rounded-full text-red-400 hover:bg-slate-700 text-sm">
                    Logout
                </button>
            )}
            <button onClick={() => setShowSettings(true)} className="p-3 bg-slate-800 rounded-full">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
          </div>
        </div>

        {tab === 'summary' && <SummaryTab data={todaysData} allFood={foodLog} allGym={gymLog} allCardio={cardioLog} />}
        {tab === 'food' && <FoodTab data={todaysData} isReady={isReady} userId={userId} showToast={showToast} />}
        {tab === 'gym' && <GymTab workouts={workouts} setWorkouts={setWorkouts} isReady={isReady} userId={userId} showToast={showToast} />}
        {tab === 'cardio' && <CardioTab isReady={isReady} userId={userId} showToast={showToast} />}

        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-2xl border border-slate-800 rounded-full shadow-2xl flex z-50">
          <button onClick={() => setTab('summary')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'summary' ? 'bg-cyan-600 text-white' : 'text-slate-500'}`}>Summary</button>
          <button onClick={() => setTab('food')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'food' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>Food</button>
          <button onClick={() => setTab('gym')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'gym' ? 'bg-pink-600 text-white' : 'text-slate-500'}`}>Gym</button>
          <button onClick={() => setTab('cardio')} className={`px-8 py-4 rounded-full font-black text-sm ${tab === 'cardio' ? 'bg-orange-600 text-white' : 'text-slate-500'}`}>Cardio</button>
        </div>
      </div>
    );
  };

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
